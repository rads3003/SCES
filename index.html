<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Capacitaci√≥n - Guardias de Seguridad</title>
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #141827;
      --bg-card: #1a1f35;
      --accent: #00d9ff;
      --accent-glow: rgba(0, 217, 255, 0.3);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.3;
      animation: float 20s infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translate(0, 0);
        opacity: 0;
      }

      50% {
        opacity: 0.5;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding: 25px;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 53, 0.6) 100%);
      border-radius: 20px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, #ffffff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 5px;
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      color: #070a1a;
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px var(--accent-glow);
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    button.ghost:hover {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--accent);
    }

    /* Estilo para bot√≥n de biometr√≠a activa */
    button#btn-face-analysis.active {
      background: var(--success);
      color: var(--bg-primary);
      box-shadow: 0 0 10px var(--success);
      border: 1px solid var(--success);
    }


    .card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 53, 0.8) 100%);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px var(--accent-glow);
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
    }

    /* Area Selection */
    .area-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .area-card {
      cursor: pointer;
      position: relative;
      overflow: hidden;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .area-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent) 0%, #0080ff 100%);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .area-card.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(0, 128, 255, 0.05) 100%);
    }

    .area-card:hover::before {
      transform: scaleX(1);
    }

    .area-icon {
      font-size: 48px;
      margin-bottom: 15px;
      filter: drop-shadow(0 4px 8px var(--accent-glow));
    }

    .area-card h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--accent);
    }

    /* Scenario Cards */
    .scenarios-grid {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }

    .scenario-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .scenario-card:hover {
      border-color: var(--accent);
    }

    .scenario-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .scenario-card:hover::before {
      transform: scaleY(1);
    }

    .difficulty-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .difficulty-facil {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .difficulty-medio {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .difficulty-alto {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    /* Game View */
    .game-container {
      min-height: 500px;
    }

    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, transparent 100%);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
    }

    /* Estilos del M√≥dulo Biometr√≠a */
    .face-analysis-module {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .face-analysis-module video,
    .face-analysis-module canvas {
      width: 120px;
      height: 90px;
      background: var(--bg-secondary);
      border: 2px solid var(--danger);
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
      transform: scaleX(-1);
      /* Simular espejo */
      transition: all 0.3s ease;
    }

    .face-analysis-module.active video,
    .face-analysis-module.active canvas {
      border-color: var(--success);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
    }

    .timer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      padding: 10px 20px;
      background: rgba(0, 217, 255, 0.1);
      border-radius: 8px;
    }

    .timer.warning {
      color: var(--warning);
      background: rgba(245, 158, 11, 0.1);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.6;
      }
    }

    .node-content {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 25px;
      border-left: 4px solid var(--accent);
      position: relative;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .node-text {
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .choices-grid {
      display: grid;
      gap: 15px;
    }

    .choice-btn {
      padding: 20px;
      text-align: left;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 53, 0.6) 100%);
      border: 2px solid var(--border);
      border-radius: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      /* FORZAR LETRAS BLANCAS PARA MEJOR VISUALIZACION */
      color: var(--text-primary);
    }

    .choice-btn * {
      /* Aplicar tambi√©n a sub-elementos para garantizar el contraste */
      color: var(--text-primary) !important;
    }

    .choice-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .choice-btn:hover {
      border-color: var(--accent);
      transform: translateX(10px);
    }

    .choice-btn:hover::before {
      opacity: 0.1;
    }

    .choice-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .choice-effects {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .effect-tag {
      padding: 3px 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 12px;
    }

    /* Sobrescribir el color del texto del tag solo donde sea necesario */
    .effect-positive {
      color: var(--success) !important;
      background: rgba(16, 185, 129, 0.1);
    }

    .effect-negative {
      color: var(--danger) !important;
      background: rgba(239, 68, 68, 0.1);
    }

    /* Feedback Section */
    .feedback-card {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
      border-left: 4px solid var(--success);
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .feedback-card.warning {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
      border-left-color: var(--danger);
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 20px;
      height: fit-content;
    }

    .user-panel {
      margin-bottom: 20px;
    }

    .user-input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      margin-top: 10px;
      /* Added spacing for new fields */
    }

    /* Override for first input */
    #user-name {
      margin-top: 10px;
      /* To separate from h3 */
    }

    .user-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(0, 217, 255, 0.05);
    }

    .dimensions-list {
      display: grid;
      gap: 12px;
      margin-top: 15px;
    }

    .dimension-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .dimension-item:hover {
      background: rgba(0, 217, 255, 0.05);
    }

    .dimension-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .dimension-value {
      font-weight: 700;
      font-size: 18px;
      color: var(--accent);
    }

    .progress-bar-container {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.05) 0%, transparent 100%);
      border-radius: 12px;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, #0080ff 100%);
      border-radius: 999px;
      transition: width 0.5s ease;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    /* Report View */
    .report-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .report-header {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, transparent 100%);
      border-radius: 16px;
      margin-bottom: 30px;
    }

    .final-score {
      font-size: 64px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 20px 0;
    }

    .report-section {
      margin-bottom: 25px;
    }

    .report-section h3 {
      color: var(--accent);
      margin-bottom: 15px;
      font-size: 20px;
    }

    .action-list {
      display: grid;
      gap: 10px;
    }

    .action-item {
      padding: 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: static;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 20px;
      }

      .header-actions {
        flex-wrap: wrap;
      }

      .area-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="particles" id="particles"></div>

  <div id="notification-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="color: var(--accent); margin-bottom: 15px;"></h3>
      <p id="modal-message" style="color: var(--text-primary); margin-bottom: 20px;"></p>
      <button class="primary" onclick="hideModal()">Aceptar</button>
    </div>
  </div>


  <div class="container">
    <header>
      <div class="logo">üõ°Ô∏è</div>
      <div style="flex: 1;">
        <h1>Simulador de aplicaci√≥n de protocolos para Eventos Cr√≠ticos</h1>
        <div class="subtitle">Entrena decisiones cr√≠ticas con escenarios realistas y feedback inmediato</div>
      </div>
      <div class="header-actions">
        <button class="ghost" id="btn-face-analysis">üëÅÔ∏è Biometr√≠a Facial</button>
        <button class="ghost" id="btn-tts">üîä Voz</button>
        <button class="ghost" id="btn-admin">‚öôÔ∏è Admin</button>
        <button class="ghost" id="btn-reset">‚ôªÔ∏è Reset</button>
      </div>
    </header>

    <div class="main-layout">
      <main>
        <div id="view-area" class="card">
          <h2 style="margin-bottom: 20px;">Selecciona tu √°rea de desempe√±o</h2>
          <div class="area-grid">
            <div class="area-card card" data-area="comercial" tabindex="0">
              <div class="area-icon">üè™</div>
              <h3>Comercial / Retail</h3>
              <p style="color: var(--text-secondary);">Mall, supermercados y centros comerciales. Enfoque en atenci√≥n al
                p√∫blico, prevenci√≥n de hurtos y emergencias.</p>
            </div>
            <div class="area-card card" data-area="industrial" tabindex="0">
              <div class="area-icon">üè≠</div>
              <h3>Industrial</h3>
              <p style="color: var(--text-secondary);">Plantas industriales - seguridad de per√≠metro, maquinaria,
                riesgos qu√≠micos y emergencias laborales.</p>
            </div>
            <div class="area-card card" data-area="servicio" tabindex="0">
              <div class="area-icon">üè¢</div>
              <h3>Servicio / Corporativo</h3>
              <p style="color: var(--text-secondary);">Edificios de oficinas, corporativos y de servicios. Enfoque en
                control de acceso, paquetes sospechosos y protecci√≥n ejecutiva.</p>
            </div>
            <div class="area-card card" data-area="salud" tabindex="0">
              <div class="area-icon">üè•</div>
              <h3>Salud / Hospitalario</h3>
              <p style="color: var(--text-secondary);">Cl√≠nicas, laboratorios y hospitales. Enfoque en control de
                visitas, usuarios, manejo de personas agresivas y seguridad de zonas sensibles.</p>
            </div>
            <div class="area-card card" data-area="mineria" tabindex="0">
              <div class="area-icon">‚õèÔ∏è</div>
              <h3>Miner√≠a</h3>
              <p style="color: var(--text-secondary);">Faenas y sitios de extracci√≥n remotos. Enfoque en seguridad
                perimetral, control de ingreso, materiales de alto valor y respuesta a accidentes con maquinaria.</p>
            </div>
            <div class="area-card card" data-area="energia" tabindex="0">
              <div class="area-icon">‚ö°</div>
              <h3>Energ√≠a</h3>
              <p style="color: var(--text-secondary);">Subestaciones, plantas de poder e infraestructura cr√≠tica.
                Enfoque en prevenci√≥n de sabotaje, control de acceso y manejo de emergencias.</p>
            </div>
            <div class="area-card card" data-area="entidades_portuarias" tabindex="0">
              <div class="area-icon">üö¢</div>
              <h3>Entidades Portuarias</h3>
              <p style="color: var(--text-secondary);">Terminales mar√≠timos, zonas de aduana y log√≠stica de carga.
                Enfoque en control de acceso, seguridad perimetral y manejo de carga cr√≠tica.</p>
            </div>
            <div class="area-card card" data-area="otros_servicios" tabindex="0">
              <div class="area-icon">‚≠ê</div>
              <h3>Otros Servicios / Eventos</h3>
              <p style="color: var(--text-secondary);">Eventos masivos, servicios puntuales o temporales. Enfoque en
                control de multitudes, prevenci√≥n y r√°pida respuesta t√°ctica.</p>
            </div>
          </div>

          <div id="scenarios-container" style="display: none; margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3>Escenarios disponibles</h3>
              <button class="primary" id="btn-random">üé≤ Iniciar Aleatorio</button>
            </div>
            <div class="scenarios-grid" id="scenarios-list"></div>
          </div>
        </div>

        <div id="view-play" style="display: none; position: relative;">
          <div id="face-analysis-module" class="face-analysis-module" style="display: none;">
            <canvas id="face-canvas" style="position: absolute;"></canvas>
            <video id="face-video" style="display: block;"></video>
            <small id="face-status" style="margin-top: 5px; color: var(--text-secondary); font-size: 10px;"></small>
          </div>
          <div class="card game-container">
            <div class="scenario-header">
              <div>
                <h2 id="scenario-title">T√≠tulo del Escenario</h2>
                <div class="subtitle" id="scenario-meta">Meta info</div>
              </div>
              <div class="timer-group" style="display: flex; gap: 15px; align-items: center;">
                <div class="timer" id="timer">
                  <span>‚è±Ô∏è</span>
                  <span id="timer-value">00:00</span>
                </div>

                <div id="tension-meter"
                  style="width: 150px; height: 40px; border: 1px solid var(--border); border-radius: 8px; padding: 5px; background: var(--bg-secondary); transition: all 0.3s ease;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">‚ö° Tensi√≥n Operacional
                  </div>
                  <div class="progress-bar" style="height: 10px; margin-top: 0;">
                    <div id="tension-fill" class="progress-fill"
                      style="width: 0%; background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="node-content">
              <div class="node-text" id="node-text"></div>
              <div id="node-media"></div>
            </div>

            <div class="choices-grid" id="choices"></div>
          </div>

          <div class="card feedback-card" id="feedback-card" style="display: none;">
            <h3 style="margin-bottom: 10px;">üìã Feedback Inmediato</h3>
            <div id="immediate-feedback"></div>
            <div style="margin-top: 10px; color: var(--text-secondary);">
              Acciones realizadas: <strong id="actions-count" style="color: var(--accent);">0</strong>
            </div>
          </div>
        </div>

        <div id="view-report" style="display: none;">
          <div class="report-container">
            <div class="card report-header">
              <h2>üèÜ Reporte Final</h2>
              <div class="final-score" id="final-score">85%</div>
              <div class="subtitle">Excelente desempe√±o en este escenario</div>
            </div>

            <div class="card report-section">
              <h3>üìä Dimensiones Evaluadas</h3>
              <div id="report-dimensions"></div>
            </div>

            <div class="card report-section">
              <h3>üìù Acciones Registradas</h3>
              <div class="action-list" id="report-actions"></div>
            </div>

            <div class="card report-section">
              <h3>üí° Retroalimentaci√≥n</h3>
              <div id="report-feedback"></div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px;">
              <button class="ghost" id="btn-export-json">üì• Descargar JSON</button>
              <button class="ghost" id="btn-print">üñ®Ô∏è Imprimir PDF</button>
              <button class="primary" id="btn-replay" style="margin-left: auto;">üîÑ Reintentar Escenario</button>
            </div>
          </div>
        </div>
      </main>

      <aside class="sidebar">
        <div class="card user-panel">
          <h3 style="margin-bottom: 15px;">üë§ Usuario</h3>
          <input type="text" class="user-input" id="user-name" placeholder="Ingresa tu Nombre">
          <input type="text" class="user-input" id="user-rut" placeholder="Ingresa tu RUT (Ej: 12.345.678-9)">
          <input type="text" class="user-input" id="user-facility" placeholder="Instalaci√≥n/Sede">

          <div style="margin-top: 20px;">
            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 10px;">Sesiones guardadas:
              <strong id="sessions-count" style="color: var(--accent);">0</strong>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="ghost" id="btn-save-session" style="flex: 1;">üíæ Guardar</button>
              <button class="ghost" id="btn-load-session" style="flex: 1;">üìÇ Cargar</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 15px;">üìä Dimensiones</h3>
          <div class="dimensions-list">
            <div class="dimension-item">
              <span class="dimension-label">Procedimental</span>
              <span class="dimension-value" id="dim-procedural">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Seguridad</span>
              <span class="dimension-value" id="dim-security">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Comunicaciones</span>
              <span class="dimension-value" id="dim-comms">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Tiempo</span>
              <span class="dimension-value" id="dim-time">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Empat√≠a</span>
              <span class="dimension-value" id="dim-empathy">0</span>
            </div>
          </div>

          <div class="progress-bar-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="font-size: 14px;">Progreso Total</span>
              <span style="font-weight: 600; color: var(--accent);" id="partial-score">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div class="card" id="admin-panel" style="display: none; margin-top: 20px;">
          <h3 style="margin-bottom: 15px;">‚öôÔ∏è Panel de Administraci√≥n</h3>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
            Edita o pega JSON de escenarios personalizados
          </p>
          <textarea id="admin-json" class="user-input" style="height: 200px; font-family: monospace; font-size: 12px;" placeholder="{ ... }"></textarea>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="primary" id="btn-load-json" style="flex: 1;">üì§ Cargar JSON</button>
            <button class="ghost" id="btn-export-json-admin" style="flex: 1;">üì• Exportar</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Configuraci√≥n
    const DIMENSIONS = ['procedural', 'security', 'comms', 'time', 'empathy'];
    const WEIGHTS = {procedural: 0.4, security: 0.3, comms: 0.15, time: 0.1, empathy: 0.05};
    
    // Configuraci√≥n de Reacci√≥n T√°ctica (en milisegundos)
    const MAX_REACTION_TIME = 20000; // 20 segundos para vacilaci√≥n
    const MIN_REACTION_TIME = 3000;  // 3 segundos para impulsividad
    
    // Estado del juego
    let gameState = {
      currentArea: null,
      currentScenario: null,
      currentNode: null,
      dimensions: {procedural: 0, security: 0, comms: 0, time: 0, empathy: 0},
      actions: [],
      startTime: null,
      timerInterval: null,
      score: 0,
      tensionLevel: 0, 
      nodeLoadTime: 0, 
      faceAnalysisActive: false // NUEVO: Flag para la biometr√≠a
    };
    
    // --- L√≥gica del Modal de Notificaci√≥n ---
    function showModal(title, message) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        document.getElementById('notification-modal').classList.add('active');
    }

    function hideModal() {
        document.getElementById('notification-modal').classList.remove('active');
    }

    // Funciones de utilidad de la interfaz
    function switchView(viewId) {
        document.getElementById('view-area').style.display = 'none';
        document.getElementById('view-play').style.display = 'none';
        document.getElementById('view-report').style.display = 'none';
        
        // Esconder feedback al cambiar de vista
        document.getElementById('feedback-card').style.display = 'none';

        const targetView = document.getElementById(viewId);
        if (targetView) {
            targetView.style.display = 'block';
        }
    }
    
    function updateTimerDisplay() {
        if (!gameState.startTime) return;
        const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
        const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const seconds = String(elapsed % 60).padStart(2, '0');
        const timerElement = document.getElementById('timer-value');
        timerElement.textContent = `${minutes}:${seconds}`;
        
        // Alerta visual de tiempo
        const timerContainer = document.getElementById('timer');
        if (elapsed > 300) { // 5 minutos de advertencia
             timerContainer.classList.add('warning');
        } else {
             timerContainer.classList.remove('warning');
        }
    }

    function startTimer() {
        clearInterval(gameState.timerInterval);
        gameState.startTime = Date.now();
        gameState.timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    function stopTimer() {
        clearInterval(gameState.timerInterval);
    }
    
    function updateDimensionsDisplay() {
        DIMENSIONS.forEach(dim => {
            document.getElementById(`dim-${dim}`).textContent = gameState.dimensions[dim];
        });
        document.getElementById('actions-count').textContent = gameState.actions.length;
        
        const currentScore = calculatePartialScore();
        document.getElementById('partial-score').textContent = `${currentScore}%`;
        document.getElementById('progress-bar').style.width = `${currentScore}%`;
    }

    // Funci√≥n para actualizar el medidor de tensi√≥n
    function updateTensionDisplay() {
        const maxTension = 100; // M√°ximo de 100% de tensi√≥n
        let tension = Math.min(maxTension, Math.max(0, gameState.tensionLevel));

        // La tensi√≥n se calcula sobre 100%
        const percentage = (tension / maxTension) * 100;

        const tensionFill = document.getElementById('tension-fill');
        const tensionMeter = document.getElementById('tension-meter');
        if (tensionFill) {
            tensionFill.style.width = `${percentage}%`;
            
            // Efecto visual de alto riesgo si la tensi√≥n es > 70
            if (tension > 70) {
                tensionMeter.style.borderColor = 'var(--danger)';
                tensionMeter.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.6)';
            } else if (tension > 40) {
                tensionMeter.style.borderColor = 'var(--warning)';
                tensionMeter.style.boxShadow = 'none';
            } else {
                tensionMeter.style.borderColor = 'var(--border)';
                tensionMeter.style.boxShadow = 'none';
            }
        }
    }

    // Funci√≥n para manejar la activaci√≥n de la c√°mara y la simulaci√≥n
    async function toggleFaceAnalysis() {
        const btn = document.getElementById('btn-face-analysis');
        const module = document.getElementById('face-analysis-module');
        const video = document.getElementById('face-video');
        const status = document.getElementById('face-status');

        if (!gameState.faceAnalysisActive) {
            // Simulaci√≥n de solicitud de permisos
            try {
                // Intentar obtener el stream (esto activar√° el cuadro de di√°logo de permisos del navegador)
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.play();
                module.style.display = 'flex';
                module.classList.add('active');
                btn.classList.add('active');
                btn.textContent = 'üëÅÔ∏è Biometr√≠a ACTIVA';
                status.textContent = 'An√°lisis de Tensi√≥n ON';
                gameState.faceAnalysisActive = true;
                showModal('‚úÖ M√≥dulo de Biometr√≠a Activado', 'El sistema est√° leyendo sus **microexpresiones faciales**. Esto afectar√° directamente su puntuaci√≥n de **Tensi√≥n Operacional** y **Procedimiento**.');
            } catch (err) {
                // Si el usuario niega o hay un error, simulamos la activaci√≥n sin el video real
                module.style.display = 'flex';
                module.classList.add('active');
                btn.classList.add('active');
                btn.textContent = 'üëÅÔ∏è Biometr√≠a (Simulada)';
                status.textContent = 'ERROR: No Camera. Simulaci√≥n ON';
                gameState.faceAnalysisActive = true;
                showModal('‚ö†Ô∏è M√≥dulo de Biometr√≠a (Simulado)', 'El sistema de biometr√≠a se ha activado en modo simulaci√≥n debido a un bloqueo de c√°mara. Su **Tensi√≥n Operacional** seguir√° siendo penalizada.');
            }
        } else {
            // Desactivar
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            module.style.display = 'none';
            module.classList.remove('active');
            btn.classList.remove('active');
            btn.textContent = 'üëÅÔ∏è Biometr√≠a Facial';
            status.textContent = '';
            gameState.faceAnalysisActive = false;
        }
    }

    function calculatePartialScore() {
        let totalWeightedScore = 0;
        // Max score for each dimension is 20 points.
        // Formula: (procedural*0.4) + (security*0.3) + (comms*0.15) + (time*0.1) + (empathy*0.05)
        // If all are 20: (20 * 0.4) + (20 * 0.3) + (20 * 0.15) + (20 * 0.1) + (20 * 0.05) = 20
        DIMENSIONS.forEach(dim => {
            totalWeightedScore += gameState.dimensions[dim] * WEIGHTS[dim];
        });

        // Normalize the score to a 0-100 range, capping at 100.
        // We use a factor of 5 to scale max 20 points to 100%.
        const normalizedScore = Math.min(100, Math.max(0, totalWeightedScore * 5));
        return Math.round(normalizedScore);
    }


    // --- L√≥gica del Juego ---
    function selectArea(areaId) {
        gameState.currentArea = areaId;
        const scenarios = SCENARIOS[areaId];
        const list = document.getElementById('scenarios-list');
        list.innerHTML = '';

        // Activar la clase 'selected'
        document.querySelectorAll('.area-card').forEach(card => card.classList.remove('selected'));
        const selectedCard = document.querySelector(`.area-card[data-area="${areaId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        } else {
            // Manejar la selecci√≥n si se carga un √°rea que no est√° visible, por ejemplo, al cargar una sesi√≥n.
            // Esto es crucial para √°reas reci√©n a√±adidas que podr√≠an no tener un card visible inicialmente.
            // En este caso, todas tienen un card, pero es un buen control de errores.
        }

        // Mostrar escenarios
        if (scenarios && scenarios.length > 0) {
            scenarios.forEach(scenario => {
                const badgeClass = `difficulty-${scenario.difficulty}`;
                const scenarioElement = document.createElement('div');
                scenarioElement.className = 'scenario-card card';
                scenarioElement.innerHTML = `
                    <div>
                        <h4 style="margin-bottom: 5px;">${scenario.title} <span class="difficulty-badge ${badgeClass}">${scenario.difficulty.toUpperCase()}</span></h4>
                        <p style="font-size: 13px; color: var(--text-secondary);">Tiempo Estimado: ${scenario.est_time} min</p>
                    </div>
                    <button class="primary" data-scenario-id="${scenario.id}">Iniciar</button>
                `;
                scenarioElement.querySelector('button').addEventListener('click', () => startScenario(scenario.id));
                list.appendChild(scenarioElement);
            });
            document.getElementById('scenarios-container').style.display = 'block';
        } else {
            list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No hay escenarios disponibles para esta √°rea.</p>';
            document.getElementById('scenarios-container').style.display = 'block';
        }
    }

    function startScenario(scenarioId) {
        const area = gameState.currentArea;
        if (!area || !SCENARIOS[area]) {
            showModal('Error', 'Debe seleccionar un √°rea de desempe√±o primero.');
            return;
        }
        
        const scenario = SCENARIOS[area].find(s => s.id === scenarioId);
        if (!scenario) {
            showModal('Error', 'Escenario no encontrado.');
            return;
        }

        // 1. Resetear Estado
        gameState.currentScenario = scenario;
        gameState.dimensions = {procedural: 0, security: 0, comms: 0, time: 0, empathy: 0};
        gameState.actions = [];
        gameState.tensionLevel = 0; // Resetear Tensi√≥n Operacional

        // 2. Actualizar UI y comenzar
        document.getElementById('scenario-title').textContent = scenario.title;
        document.getElementById('scenario-meta').innerHTML = `√Årea: ${scenario.area.toUpperCase()} | Dificultad: <span class="difficulty-badge difficulty-${scenario.difficulty}">${scenario.difficulty.toUpperCase()}</span> | Tiempo Estimado: ${scenario.est_time} min`;
        
        updateDimensionsDisplay();
        updateTensionDisplay();
        
        switchView('view-play');
        startTimer();
        
        // 3. Cargar el primer nodo
        loadNode(scenario.start);
    }
    
    function startRandomScenario() {
        const areas = Object.keys(SCENARIOS);
        if (areas.length === 0) {
            showModal('Error', 'No hay escenarios configurados.');
            return;
        }
        
        // Seleccionar un √°rea aleatoria
        const randomAreaId = areas[Math.floor(Math.random() * areas.length)];
        gameState.currentArea = randomAreaId;
        
        const scenarios = SCENARIOS[randomAreaId];
        if (!scenarios || scenarios.length === 0) {
             showModal('Error', `El √°rea ${randomAreaId} no tiene escenarios.`);
             return;
        }
        
        // Seleccionar un escenario aleatorio
        const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
        startScenario(randomScenario.id);
    }

    function loadNode(nodeId) {
        const scenario = gameState.currentScenario;
        if (!scenario) return;

        const node = scenario.nodes[nodeId];
        if (!node) {
            showModal('Error de Configuraci√≥n', `El nodo "${nodeId}" no existe en el escenario.`);
            return;
        }
        
        gameState.currentNode = nodeId;
        gameState.nodeLoadTime = Date.now(); // Registrar el tiempo de carga del nodo

        // 1. Mostrar el contenido del nodo
        document.getElementById('node-text').textContent = node.text;
        // Limpiar y (posiblemente) cargar media (no implementado en este simulador, solo se limpia)
        document.getElementById('node-media').innerHTML = ''; 
        
        // 2. Ocultar feedback
        document.getElementById('feedback-card').style.display = 'none';

        // 3. Mostrar opciones o finalizar
        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';

        if (node.type === 'end') {
            stopTimer();
            const finalScore = calculatePartialScore();
            
            // Generar mensaje final basado en la puntuaci√≥n
            let endMessage = '';
            if (finalScore >= 80) {
                endMessage = '¬°√âxito T√°ctico! Demostraste un nivel de protocolo y control excepcional.';
            } else if (finalScore >= 50) {
                endMessage = 'Desempe√±o Aceptable. Hubo puntos cr√≠ticos, pero la misi√≥n fue completada.';
            } else {
                endMessage = 'Falla Cr√≠tica. El procedimiento fall√≥ y el riesgo operacional aument√≥.';
            }

            // Un peque√±o retraso para que el usuario lea el resultado del √∫ltimo nodo
            setTimeout(() => showReport(finalScore, node.text || endMessage), 2000);
            
        } else {
            // Mostrar las opciones
            const nodeChoices = node.choices;
            if (nodeChoices && nodeChoices.length > 0) {
                nodeChoices.forEach(choiceId => {
                    const choice = scenario.choices[choiceId];
                    if (choice) {
                        const choiceElement = document.createElement('div');
                        choiceElement.className = 'choice-btn';
                        choiceElement.setAttribute('tabindex', '0');
                        choiceElement.innerHTML = `
                            <div class="choice-title">Acci√≥n: ${choice.desc}</div>
                            <div class="choice-effects">
                                ${DIMENSIONS.map(dim => {
                                    const effect = choice.effects[dim] || 0;
                                    if (effect !== 0) {
                                        const sign = effect > 0 ? '+' : '';
                                        const colorClass = effect > 0 ? 'effect-positive' : 'effect-negative';
                                        return `<span class="effect-tag ${colorClass}">${sign}${effect} ${dim.charAt(0).toUpperCase() + dim.slice(1)}</span>`;
                                    }
                                    return '';
                                }).join('')}
                                <span class="effect-tag">Tiempo: ${choice.from.startsWith('n_') ? 'Variable' : 'N/A'}</span>
                            </div>
                        `;
                        choiceElement.addEventListener('click', () => handleChoice(choiceId));
                        choicesDiv.appendChild(choiceElement);
                    }
                });
            } else {
                choicesDiv.innerHTML = '<p style="color: var(--danger);">Error: No hay opciones disponibles para este nodo. (Fin inesperado)</p>';
            }
        }
    }
    
    // Funci√≥n para analizar el tiempo de reacci√≥n (Tiempo de Decisi√≥n)
    function analyzeReactionTime() {
        if (!gameState.nodeLoadTime) return {timeScore: 0, info: ''};

        const reactionTime = Date.now() - gameState.nodeLoadTime;
        let scoreChange = 0;
        let info = `Decisi√≥n en ${Math.floor(reactionTime / 1000)}s.`;

        if (reactionTime > MAX_REACTION_TIME) {
            scoreChange = -5;
            info += ' | ‚ö†Ô∏è **VACILACI√ìN:** Demora en la toma de decisi√≥n.';
        } else if (reactionTime < MIN_REACTION_TIME) {
            scoreChange = -5;
            info += ' | üö® **IMPULSIVIDAD:** Decisi√≥n demasiado r√°pida.';
        } else {
            scoreChange = 5;
            info += ' | ‚úÖ **REACCI√ìN √ìPTIMA:** Tiempo de respuesta adecuado.';
        }
        
        // Sumar al score de tiempo
        gameState.dimensions.time = Math.max(-20, gameState.dimensions.time + scoreChange);

        return {timeScore: scoreChange, info: info, reactionTime: reactionTime};
    }
    
    // Funci√≥n para simular el an√°lisis facial (Biometr√≠a)
    function analyzeFaceExpression(tensionChange) {
        let bioFeedback = '';
        let tensionModifier = 0; // Modificador adicional a la tensi√≥n por el an√°lisis facial
        
        if (gameState.faceAnalysisActive) {
             // Simulaci√≥n de detecci√≥n: si la tensi√≥n base est√° aumentando mucho, o el agente tiene baja empat√≠a, 
             // o tiene bajo procedimiento, simular una expresi√≥n negativa
             const proceduralCheck = gameState.dimensions.procedural < -5;
             const empathyCheck = gameState.dimensions.empathy < 0;
             const highTensionBase = tensionChange > 5;

             if (highTensionBase || proceduralCheck || empathyCheck) {
                // Simular Detecci√≥n de Estr√©s / Enojo / Miedo
                tensionModifier = 10; // Aumentar la tensi√≥n percibida
                // Penalizar Procedimiento por "Falla de Calma"
                gameState.dimensions.procedural = Math.max(-20, gameState.dimensions.procedural - 5); 
                bioFeedback += `<br><span style="color: var(--danger);">üî• **ESTR√âS DETECTADO:** Tensi√≥n (+10) y Procedimiento (-5) penalizados por microexpresiones de ${highTensionBase ? 'Ansiedad' : proceduralCheck ? 'Frustraci√≥n' : 'Enojo'}.</span>`;
             } else {
                // Simular Calma y Control
                tensionModifier = -5; // Reducir la tensi√≥n percibida
                bioFeedback += `<br><span style="color: var(--success);">üßä **CONTROL T√ÅCTICO:** Expresi√≥n facial estable. Tensi√≥n (-5).</span>`;
             }
        } else {
             bioFeedback += `<br><span style="color: var(--warning);">üëÅÔ∏è **NEUTRALIDAD:** Expresi√≥n facial estable.</span>`;
        }
        
        return {tensionModifier: tensionModifier, bioFeedback: bioFeedback};
    }

    function handleChoice(choiceId) {
        const scenario = gameState.currentScenario;
        const choice = scenario.choices[choiceId];
        if (!choice) return;

        // 1. Analizar el tiempo de reacci√≥n
        const { timeScore, info: reactionInfo, reactionTime } = analyzeReactionTime();
        
        // 2. Determinar el cambio de tensi√≥n base (mayor seguridad, menor tensi√≥n; mayor empat√≠a, menor tensi√≥n)
        // Valores por defecto para el cambio de tensi√≥n (simulaci√≥n)
        const baseTensionChange = (choice.effects.security || 0) * -2 + // Mucho efecto en Seguridad -> Gran baja en Tensi√≥n (-2 por punto)
                                  (choice.effects.empathy || 0) * -1.5 + // Mucho efecto en Empat√≠a -> Baja moderada en Tensi√≥n (-1.5 por punto)
                                  (choice.effects.procedural || 0) * -1 + // Procedimiento -> Baja leve (-1 por punto)
                                  (choice.effects.comms || 0) * -1; // Comunicaciones -> Baja leve (-1 por punto)
        
        // Las malas decisiones aumentan la tensi√≥n
        let tensionChange = baseTensionChange;
        
        // Penalizaci√≥n por impulsividad/vacilaci√≥n. Aumenta la tensi√≥n.
        if (timeScore < 0) { 
            tensionChange += 5; 
        }

        // 3. Analizar Expresi√≥n Facial (Biometr√≠a) si est√° activo
        const { tensionModifier: bioTensionModifier, bioFeedback } = analyzeFaceExpression(tensionChange);
        tensionChange += bioTensionModifier;

        // 4. Aplicar Tensi√≥n Final
        gameState.tensionLevel = Math.min(100, Math.max(0, gameState.tensionLevel + tensionChange));
        updateTensionDisplay();

        // 5. Penalizaci√≥n/Bonificaci√≥n por Tensi√≥n al Momento de la Decisi√≥n
        let tensionScoreModifier = 0;
        if (gameState.faceAnalysisActive && gameState.tensionLevel > 80) {
            tensionScoreModifier = -2; // Penalizaci√≥n por actuar bajo extremo estr√©s
            bioFeedback += `<br><span style="color: var(--danger);">üö® **FALLA POR ESTR√âS:** Tensi√≥n extrema (>80). Se penalizan 2pts. en **Procedimiento**.</span>`;
            gameState.dimensions.procedural = Math.max(-20, gameState.dimensions.procedural + tensionScoreModifier);
        }

        // 6. Aplicar efectos de la elecci√≥n a dimensiones
        let totalEffect = 0;
        DIMENSIONS.forEach(dim => {
            const effect = choice.effects[dim] || 0;
            // La dimensi√≥n 'time' ya fue modificada por analyzeReactionTime
            // La dimensi√≥n 'procedural' ya fue modificada por tensionScoreModifier si aplica
            if (dim !== 'time' && dim !== 'procedural') {
                gameState.dimensions[dim] = Math.max(-20, gameState.dimensions[dim] + effect); // Asegurar score m√≠nimo
            } else if (dim === 'procedural') { 
                // Si es procedural, ya fue modificado por tensionScoreModifier. Sumamos el efecto base.
                gameState.dimensions[dim] = Math.max(-20, gameState.dimensions.procedural + effect); 
            }
            totalEffect += effect;
        });
        
        // Sumar la penalizaci√≥n por estr√©s al total de efectos para el log
        totalEffect += tensionScoreModifier;

        // 7. Log de acci√≥n
        gameState.actions.push({
            node: gameState.currentNode,
            choice: choice.desc,
            effects: choice.effects,
            scoreChange: totalEffect + timeScore + (choice.effects.time || 0), // Sumar los efectos de dimensi√≥n del choice + el score de tiempo (que ya fue aplicado a dimensions.time) + la penalizaci√≥n por estr√©s (tensionScoreModifier, que ya fue aplicado a dimensions.procedural)
            timeTaken: Math.floor(reactionTime / 1000),
            reactionInfo: reactionInfo,
            tension: gameState.tensionLevel,
            tensionChange: tensionChange,
            tensionPenalty: tensionScoreModifier,
            // Registrar cambio de tensi√≥n solo por la biometr√≠a (para el feedback)
            bioTensionChange: bioTensionModifier,
        });

        // 8. Mostrar feedback inmediato
        let feedback = `**Decisi√≥n:** ${choice.desc}`;
        feedback += `<br>**Efecto Neto Dimensiones:** ${totalEffect >= 0 ? '+' : ''}${totalEffect} puntos.`;
        feedback += `<br>${reactionInfo}. **Ajuste de Tiempo:** ${timeScore >= 0 ? '+' : ''}${timeScore} puntos.`;
        feedback += bioFeedback;
        
        // Retroalimentaci√≥n de Tensi√≥n
        const baseTensionChangeLogged = baseTensionChange + (timeScore < 0 ? 5 : 0) + (choice.effects.security || 0) * -2 + (choice.effects.empathy || 0) * -1.5 + (choice.effects.procedural || 0) * -1 + (choice.effects.comms || 0) * -1; // Ajuste para el log, no usar la variable tensionChange que incluye biometr√≠a.

        if (tensionChange > 10) {
            feedback += `<br><span style="color: var(--danger);">‚ö° **ALERTA DE ESTR√âS:** Tu acci√≥n y/o tensi√≥n biol√≥gica aument√≥ la Tensi√≥n Operacional en ${Math.round(tensionChange)} puntos.</span>`;
        } else if (tensionChange < -5) {
            feedback += `<br><span style="color: var(--success);">üßò **CONTROL T√ÅCTICO:** Tu acci√≥n y/o calma mental redujo la Tensi√≥n Operacional en ${Math.round(tensionChange * -1)} puntos.</span>`;
        }

        document.getElementById('immediate-feedback').innerHTML = feedback;

        const feedbackCard = document.getElementById('feedback-card');
        feedbackCard.classList.remove('warning');
        if (totalEffect < 0 || tensionChange > 0 || reactionTime < MIN_REACTION_TIME || reactionTime > MAX_REACTION_TIME) {
            feedbackCard.classList.add('warning');
            feedbackCard.style.borderLeftColor = 'var(--danger)';
        } else {
            feedbackCard.style.borderLeftColor = 'var(--success)';
        }
        feedbackCard.style.display = 'block';

        updateDimensionsDisplay();

        // Cargar el siguiente nodo
        if (choice.to) {
            loadNode(choice.to);
        } else {
            // Error en la configuraci√≥n del escenario
            showModal('Error Cr√≠tico', `Configuraci√≥n de escenario incompleta en la opci√≥n: ${choice.desc}`);
            // Recargar el nodo actual para evitar un loop
            loadNode(gameState.currentNode); 
        }
    }

    function showReport(finalScore, endMessage) {
        document.getElementById('final-score').textContent = `${finalScore}%`;
        document.querySelector('.report-header .subtitle').textContent = endMessage;

        // Dimensiones
        const reportDimensions = document.getElementById('report-dimensions');
        reportDimensions.innerHTML = DIMENSIONS.map(dim => {
            const value = gameState.dimensions[dim];
            const color = value >= 10 ? 'var(--success)' : value >= 0 ? 'var(--warning)' : 'var(--danger)';
            const label = dim.charAt(0).toUpperCase() + dim.slice(1);
            return `<div class="dimension-item">
                <span class="dimension-label">${label}</span>
                <span class="dimension-value" style="color: ${color};">${value}</span>
            </div>`;
        }).join('');

        // Acciones
        const reportActions = document.getElementById('report-actions');
        reportActions.innerHTML = gameState.actions.map(action => {
            const time = action.timeTaken;
            const tensionInfo = action.tensionChange !== undefined ? ` | Tensi√≥n: ${Math.round(action.tension)} (${action.tensionChange >= 0 ? '+' : ''}${Math.round(action.tensionChange)})` : '';
            const tensionPenalty = action.tensionPenalty < 0 ? ` (Penalizaci√≥n por Estr√©s: ${action.tensionPenalty})` : '';
            const reactionInfo = action.reactionInfo ? action.reactionInfo.split(' | ')[1] : 'N/A';
            const bioTension = action.bioTensionChange !== undefined ? ` | BioTensi√≥n: ${action.bioTensionChange >= 0 ? '+' : ''}${action.bioTensionChange}` : '';

            // Clasificar por √©xito/falla
            const borderClass = action.scoreChange > 0 ? 'var(--success)' : action.scoreChange < 0 ? 'var(--danger)' : 'var(--warning)';

            return `<div class="action-item" style="border-left-color: ${borderClass};">
                <p style="font-weight: 600;">${action.choice} <span style="font-size: 14px; color: ${borderClass};">${action.scoreChange >= 0 ? '+' : ''}${action.scoreChange} pts${tensionPenalty}</span></p>
                <small style="color: var(--text-secondary);">Tiempo: ${time}s | Reacci√≥n: ${reactionInfo}${bioTension}${tensionInfo} | Nodo: ${action.node}</small>
            </div>`;
        }).join('');

        // Retroalimentaci√≥n (simplificada por ahora)
        const reportFeedback = document.getElementById('report-feedback');
        let overallFeedback = '';
        const finalTension = gameState.actions.length > 0 ? gameState.actions[gameState.actions.length - 1].tension : 0;

        if (finalScore >= 80) {
            overallFeedback = `<p style="color: var(--success);">**An√°lisis de √âlite:** Rendimiento excepcional. Protocolos seguidos con rigurosidad y excelente control de la situaci√≥n (Tensi√≥n final: ${Math.round(finalTension)}). Su tiempo de reacci√≥n fue decisivo.</p>`;
        } else if (finalScore >= 50) {
            overallFeedback = `<p style="color: var(--warning);">**An√°lisis Est√°ndar:** Desempe√±o aceptable, pero hubo momentos de riesgo t√°ctico, vacilaci√≥n o impulsividad (revisar tiempos de reacci√≥n). Revise las acciones con puntuaci√≥n negativa.</p>`;
        } else {
            overallFeedback = `<p style="color: var(--danger);">**An√°lisis Cr√≠tico:** Falla operacional. Se requiere reentrenamiento. La falta de procedimiento, el alto nivel de tensi√≥n y la mala gesti√≥n del tiempo incrementaron el peligro.</p>`;
        }

        if (gameState.faceAnalysisActive) {
            overallFeedback += '<p style="margin-top: 15px; color: var(--accent);">**M√≥dulo de Biometr√≠a Activo:** La fluctuaci√≥n en su puntuaci√≥n refleja su **falta de control emocional** en los momentos de alta presi√≥n. Entrene su calma bajo fuego.</p>';
        }

        reportFeedback.innerHTML = overallFeedback;

        switchView('view-report');
    }

    // --- Inicializaci√≥n y Funcionalidad de Botones ---

    // Funcionalidades de persistencia (Guardar/Cargar/Contador)
    function saveSession() {
        const userName = document.getElementById('user-name').value;
        if (!userName) {
            alert("Por favor, ingresa tu Nombre para guardar la sesi√≥n.");
            return;
        }

        const sessionData = {
            name: userName,
            rut: document.getElementById('user-rut').value,
            facility: document.getElementById('user-facility').value,
            // Guardamos el estado actual, dimensiones y tensi√≥n
            gameState: JSON.stringify({
                dimensions: gameState.dimensions,
                tensionLevel: gameState.tensionLevel,
                actions: gameState.actions,
                currentArea: gameState.currentArea,
                currentScenarioId: gameState.currentScenario ? gameState.currentScenario.id : null,
                currentNode: gameState.currentNode,
                faceAnalysisActive: gameState.faceAnalysisActive
            }),
            timestamp: new Date().toISOString()
        };

        try {
            localStorage.setItem(`session_${userName.replace(/\s/g, '_')}`, JSON.stringify(sessionData));
            updateSessionCount();
            showModal('üíæ Sesi√≥n Guardada', `El progreso de **${userName}** ha sido guardado con √©xito.`);
        } catch (e) {
            console.error('Error al guardar la sesi√≥n:', e);
            showModal('Error', 'No se pudo guardar la sesi√≥n (puede que el navegador no lo permita o el espacio est√© lleno).');
        }
    }

    function loadSession() {
        const userName = document.getElementById('user-name').value;
        if (!userName) {
            alert("Por favor, ingresa el Nombre de la sesi√≥n a cargar.");
            return;
        }

        try {
            const savedData = localStorage.getItem(`session_${userName.replace(/\s/g, '_')}`);
            if (!savedData) {
                showModal('Error de Carga', `No se encontr√≥ una sesi√≥n guardada para **${userName}**.`);
                return;
            }

            const sessionData = JSON.parse(savedData);
            
            // Cargar datos del usuario
            document.getElementById('user-rut').value = sessionData.rut || '';
            document.getElementById('user-facility').value = sessionData.facility || '';

            // Cargar estado del juego
            const loadedState = JSON.parse(sessionData.gameState);
            
            // Cargar estado de dimensiones y tensi√≥n
            gameState.dimensions = loadedState.dimensions || {procedural: 0, security: 0, comms: 0, time: 0, empathy: 0};
            gameState.tensionLevel = loadedState.tensionLevel || 0;
            gameState.actions = loadedState.actions || [];
            gameState.faceAnalysisActive = loadedState.faceAnalysisActive || false;
            gameState.currentArea = loadedState.currentArea || null; // Cargar el √°rea

            updateDimensionsDisplay();
            updateTensionDisplay();

            // Actualizar bot√≥n de biometr√≠a
            const btn = document.getElementById('btn-face-analysis');
            const module = document.getElementById('face-analysis-module');
            if (gameState.faceAnalysisActive) {
                // Simular la activaci√≥n visual sin obtener el stream real
                btn.classList.add('active');
                btn.textContent = 'üëÅÔ∏è Biometr√≠a (Cargada)';
                module.style.display = 'flex';
                module.classList.add('active');
                document.getElementById('face-status').textContent = 'An√°lisis de Tensi√≥n ON (Cargado)';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üëÅÔ∏è Biometr√≠a Facial';
                module.style.display = 'none';
                module.classList.remove('active');
            }

            // Intentar reanudar el escenario si existe
            if (loadedState.currentScenarioId) {
                const areaId = gameState.currentArea || Object.keys(SCENARIOS).find(a => SCENARIOS[a].find(s => s.id === loadedState.currentScenarioId)) || 'comercial';
                
                selectArea(areaId); // Asegurar que el √°rea est√© seleccionada para que exista currentScenario
                const scenario = SCENARIOS[areaId].find(s => s.id === loadedState.currentScenarioId);

                if (scenario) {
                    // Reiniciar el escenario pero cargar el nodo guardado
                    startScenario(scenario.id); 
                    loadNode(loadedState.currentNode);
                    stopTimer(); // El tiempo debe ser reanudado por el usuario o manejado de forma m√°s compleja. Por simplicidad, se detiene.
                    showModal('üìÇ Sesi√≥n Cargada', `Progreso de sesi√≥n de **${userName}** cargado. Escenario reanudado en el nodo **${loadedState.currentNode}**.`);
                    return;
                }
            }
            
            // Si solo se cargaron datos de usuario/dimensiones sin escenario activo
            showModal('üìÇ Sesi√≥n Cargada', `Datos de usuario y dimensiones cargados para **${userName}**. Inicia un nuevo escenario.`);

        } catch (e) {
            console.error('El estado del juego guardado est√° corrupto o no se pudo cargar:', e);
            showModal('Error Cr√≠tico', 'El estado del juego guardado est√° corrupto. Intente reiniciar o usar otra sesi√≥n.');
        }
    }

    function updateSessionCount() {
        let count = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('session_')) {
                count++;
            }
        }
        document.getElementById('sessions-count').textContent = count;
    }

    function init() {
        // 1. Asignar eventos a las tarjetas de √°rea
        document.querySelectorAll('.area-card').forEach(card => {
            card.addEventListener('click', () => {
                selectArea(card.getAttribute('data-area'));
            });
            card.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    selectArea(card.getAttribute('data-area'));
                }
            });
        });

        // 2. Funcionalidad de Botones de Control (Header/Reporte)
        document.getElementById('btn-reset').addEventListener('click', () => {
            if (confirm('¬øEst√° seguro que desea resetear el simulador y perder el progreso actual?')) {
                localStorage.clear();
                window.location.reload();
            }
        });

        document.getElementById('btn-replay').addEventListener('click', () => {
            if (gameState.currentScenario) {
                startScenario(gameState.currentScenario.id);
            } else {
                switchView('view-area');
            }
        });

        // 3. Funcionalidad de Botones de Control (Simulaciones)
        document.getElementById('btn-tts').addEventListener('click', () => {
            showModal('üîä M√≥dulo de Voz', 'Simulaci√≥n: La funcionalidad de **Texto a Voz (TTS)** ha sido activada para la lectura de escenarios y alternativas. Desactivar para operar en silencio t√°ctico.');
        });

        // **NUEVO:** Bot√≥n de Biometr√≠a
        document.getElementById('btn-face-analysis').addEventListener('click', toggleFaceAnalysis);

        document.getElementById('btn-admin').addEventListener('click', () => {
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel.style.display === 'none') {
                adminPanel.style.display = 'block';
                showModal('‚öôÔ∏è Panel de Administraci√≥n', 'Acceso a la configuraci√≥n. Se recomienda cautela al modificar los par√°metros JSON.');
            } else {
                adminPanel.style.display = 'none';
            }
        });

        // 4. Funcionalidad de Guardar/Cargar/Aleatorio
        document.getElementById('btn-save-session').addEventListener('click', saveSession);
        document.getElementById('btn-load-session').addEventListener('click', loadSession);
        document.getElementById('btn-random').addEventListener('click', startRandomScenario);
        updateSessionCount(); // Contar sesiones guardadas al inicio

        // 5. Funcionalidad de Admin (Cargar/Exportar JSON de Escenarios)
        document.getElementById('btn-load-json').addEventListener('click', () => {
            const jsonText = document.getElementById('admin-json').value;
            try {
                const newScenarios = JSON.parse(jsonText);
                // Simple validaci√≥n: debe ser un objeto
                if (typeof newScenarios !== 'object' || newScenarios === null) {
                    throw new Error('El JSON cargado no es un objeto de escenarios v√°lido.');
                }
                
                // Sobrescribir o fusionar escenarios (Aqu√≠ optamos por sobrescribir si la clave existe)
                SCENARIOS = {...SCENARIOS, ...newScenarios};
                showModal('‚úÖ Escenarios Cargados', `Se han cargado ${Object.keys(newScenarios).length} grupos de escenarios. Recarga la vista de √°reas para verlos.`);
            } catch (e) {
                showModal('Error de JSON', `Fallo al cargar el JSON: ${e.message}`);
            }
        });

        document.getElementById('btn-export-json-admin').addEventListener('click', () => {
            const jsonStr = JSON.stringify(SCENARIOS, null, 2);
            document.getElementById('admin-json').value = jsonStr;
            showModal('JSON Exportado', 'El JSON de todos los escenarios se ha copiado al √°rea de texto para su exportaci√≥n.');
        });


        // 6. Funcionalidad de Impresi√≥n de Reporte
        document.getElementById('btn-print').addEventListener('click', () => {
            alert('Simulaci√≥n de impresi√≥n: Se abrir√≠a la ventana de impresi√≥n para el reporte.');
            // Implementaci√≥n real:
            // window.print();
        });
        
        // 7. Funcionalidad de Exportar Reporte JSON
        document.getElementById('btn-export-json').addEventListener('click', () => {
            const reportData = {
                userName: document.getElementById('user-name').value,
                rut: document.getElementById('user-rut').value,
                facility: document.getElementById('user-facility').value,
                scenario: gameState.currentScenario.title,
                finalScore: calculatePartialScore(),
                dimensions: gameState.dimensions,
                actionsLog: gameState.actions,
                timestamp: new Date().toISOString()
            };
            
            const jsonStr = JSON.stringify(reportData, null, 2);
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Reporte_${gameState.currentScenario.id}_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });


        // 8. Establecer vista inicial
        switchView('view-area');
    }

    window.onload = init;
  </script>
  <script>
    // Escenarios de ejemplo (Mismos que en la respuesta anterior, funcionales y con 2+ casos por √°rea)
    let SCENARIOS = {
      "comercial": [
        { id: 'c_hurto_simple', title: 'Hurto en pasillo', area: 'comercial', difficulty: 'facil', est_time: 5, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Son las 15:30. Un cliente reporta que un individuo ha tomado un art√≠culo de alto valor (ej. tel√©fono m√≥vil) de un estante y lo ha guardado en su chaqueta, dirigi√©ndose r√°pidamente a la salida.', choices: ['c_intercept', 'c_monitor_call', 'c_ignore']}, n_intercept: {type: 'event', text: 'Te interpones en su camino y le pides detenerse y cooperar. El individuo se pone agresivo y amenaza con empujarte.', choices: ['c_wait', 'c_force']}, n_monitor_call: {type: 'event', text: 'Mantienes la distancia y monitoreas mientras solicitas apoyo y a la polic√≠a. El sujeto llega a la zona de estacionamiento.', choices: ['c_follow_passive', 'c_wait_police']}, n_wait: {type: 'event', text: 'Esperas el apoyo, manteniendo una distancia segura pero visible. El individuo parece vacilar.', choices: ['c_talk_calmly', 'c_force_wait']}, n_end_ok: {type: 'end', text: 'El sujeto fue inmovilizado y el art√≠culo recuperado sin usar la fuerza. Procedimiento de contenci√≥n y comunicaci√≥n perfecto.'}, n_end_fail: {type: 'end', text: 'Se produce una confrontaci√≥n f√≠sica. Hay lesiones leves en ambos lados y el sujeto escapa con el art√≠culo. Falla en la desescalada.'} }, choices: { c_intercept: {from: 'n_start', to: 'n_intercept', effects: {security: 5, time: 5, procedural: 5}, desc: 'Interponerse en el camino del sospechoso y requerir la devoluci√≥n del art√≠culo'}, c_monitor_call: {from: 'n_start', to: 'n_monitor_call', effects: {procedural: 10, comms: 10, time: 10}, desc: 'Mantener distancia, activar cadena de llamado y grabar el incidente'}, c_ignore: {from: 'n_start', to: 'n_end_fail', effects: {security: -15, procedural: -10}, desc: 'Ignorar el evento y asumir que la gerencia lo manejar√° (p√©rdida de activo)'}, c_wait: {from: 'n_intercept', to: 'n_wait', effects: {empathy: 5, procedural: 10}, desc: 'Mantener la calma, no reaccionar a la agresi√≥n y esperar el apoyo visual'}, c_force: {from: 'n_intercept', to: 'n_end_fail', effects: {security: -10, empathy: -10}, desc: 'Utilizar fuerza f√≠sica inmediatamente para inmovilizar al sujeto'}, c_talk_calmly: {from: 'n_wait', to: 'n_end_ok', effects: {empathy: 10, procedural: 5}, desc: 'Hablar con calma y ofrecerle una salida sin conflicto a cambio de cooperaci√≥n'}, c_force_wait: {from: 'n_wait', to: 'n_end_fail', effects: {security: -10}, desc: 'Proceder a inmovilizarlo sin apoyo cuando estaba vacilando'}, c_follow_passive: {from: 'n_monitor_call', to: 'n_end_fail', effects: {security: -5}, desc: 'Perder al sujeto de vista o no coordinar bien la intercepci√≥n'}, c_wait_police: {from: 'n_monitor_call', to: 'n_end_ok', effects: {procedural: 15, security: 10}, desc: 'Mantener la vigilancia discreta y esperar la llegada de la polic√≠a'} } },
        { id: 'c_incendio_falso', title: 'Alarma de Incendio en Patio de Comidas', area: 'comercial', difficulty: 'medio', est_time: 7, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Recibes alerta de incendio en el patio de comidas. Se ve humo denso saliendo de un local de comida r√°pida. P√°nico leve.', choices: ['c_check', 'c_alarm', 'c_direct']}, n_check: {type: 'event', text: 'Te diriges al foco del humo. El fuego es peque√±o pero se est√° propagando r√°pidamente en la campana extractora.', choices: ['c_extinguish', 'c_evac_zone']}, n_alarm: {type: 'event', text: 'Activas la alarma general y llamas a emergencia (bomberos/jefatura) desde el puesto central.', choices: ['c_evac_full', 'c_wait_firemen']}, n_end_ok: {type: 'end', text: 'Evacuaci√≥n exitosa y contenci√≥n del fuego inicial. Se minimizan los da√±os y no hay heridos. El procedimiento de emergencia funcion√≥.'}, n_end_fail: {type: 'end', text: 'El p√°nico aumenta sin control. El fuego se extiende a la zona de p√∫blico. Hubo heridos por estampida.'} }, choices: { c_check: {from: 'n_start', to: 'n_check', effects: {time: -5}, desc: 'Ir a verificar personalmente el foco antes de activar cualquier alarma'}, c_alarm: {from: 'n_start', to: 'n_alarm', effects: {procedural: 10, comms: 10, time: 5}, desc: 'Activar la alarma general y notificar a los servicios de emergencia (Bomberos)'}, c_direct: {from: 'n_start', to: 'n_end_fail', effects: {procedural: -10, time: -10}, desc: 'Gritar a la gente que evac√∫e sin activar sistemas de alarma'}, c_extinguish: {from: 'n_check', to: 'n_end_fail', effects: {security: -10}, desc: 'Intentar apagar un fuego de campana extractora (grasa) con un extintor de agua'}, c_evac_zone: {from: 'n_check', to: 'n_end_ok', effects: {procedural: 15, security: 10}, desc: 'Aislar la zona de comida y usar un extintor clase K/Polvo, luego evacuar solo la zona afectada'}, c_evac_full: {from: 'n_alarm', to: 'n_end_ok', effects: {procedural: 10, comms: 5}, desc: 'Dirigir la evacuaci√≥n siguiendo el protocolo, aislando la zona de comida'}, c_wait_firemen: {from: 'n_alarm', to: 'n_end_fail', effects: {time: -10}, desc: 'Esperar pasivamente la llegada de Bomberos sin asistir en la evacuaci√≥n'} } }
      ],
      "industrial": [
        { id: 'i_fuga_quimica', title: 'Fuga de Qu√≠mico Corrosivo', area: 'industrial', difficulty: 'medio', est_time: 8, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Se activa una alarma en el sector de almacenamiento. Al llegar, se detecta una fuga lenta de un qu√≠mico corrosivo (etiqueta AMARILLA).', choices: ['c_isolate', 'c_check_alone', 'c_alarm_full']}, n_isolate: {type: 'event', text: 'Aislas el √°rea con barreras temporales. El olor es perceptible y podr√≠a ser peligroso.', choices: ['c_try_contain', 'c_wait_hsm']}, n_alarm_full: {type: 'event', text: 'Activaste la alarma de emergencia y notificaste a HAZMAT. El equipo de respuesta est√° en camino.', choices: ['c_evac_zone', 'c_wait_in_place']}, n_end_ok: {type: 'end', text: 'La fuga fue contenida con √©xito por el equipo HAZMAT sin riesgo para el personal. Procedimiento de respuesta de emergencia correcto.'}, n_end_fail: {type: 'end', text: 'La fuga escal√≥ antes de la llegada del personal. Hubo una exposici√≥n leve y la producci√≥n se detuvo por horas.'} }, choices: { c_isolate: {from: 'n_start', to: 'n_isolate', effects: {procedural: 10, security: 5, time: 5}, desc: 'Aislar el √°rea inmediata y notificar al supervisor'}, c_check_alone: {from: 'n_start', to: 'n_end_fail', effects: {security: -15, procedural: -10}, desc: 'Acercarse para verificar la v√°lvula sin EPP ni apoyo'}, c_alarm_full: {from: 'n_start', to: 'n_alarm_full', effects: {procedural: 15, comms: 10, time: 5}, desc: 'Activar alarma y llamar al equipo de respuesta a materiales peligrosos (HAZMAT)'}, c_try_contain: {from: 'n_isolate', to: 'n_end_fail', effects: {security: -10}, desc: 'Intentar contener la fuga sin EPP ni ser personal HAZMAT'}, c_wait_hsm: {from: 'n_isolate', to: 'n_end_ok', effects: {procedural: 10, security: 5}, desc: 'Mantener el aislamiento y esperar al equipo especializado'}, c_evac_zone: {from: 'n_alarm_full', to: 'n_end_ok', effects: {procedural: 5, security: 5}, desc: 'Proceder con la evacuaci√≥n perimetral de la zona de riesgo'}, c_wait_in_place: {from: 'n_alarm_full', to: 'n_end_fail', effects: {security: -5, time: -5}, desc: 'Esperar al equipo HAZMAT sin evacuar personal no esencial'} } },
        { id: 'i_accidente_maquina', title: 'Accidente con Atrapamiento en Maquinaria', area: 'industrial', difficulty: 'alto', est_time: 10, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Un operador de montacargas ha quedado atrapado por una carga que cay√≥. Est√° consciente, pero herido y la m√°quina sigue encendida.', choices: ['c_first_aid', 'c_isolate_power', 'c_call_rescue']}, n_isolate_power: {type: 'event', text: 'Has cortado la energ√≠a principal de la m√°quina y la zona, asegurando la escena de riesgos secundarios.', choices: ['c_start_extrication', 'c_wait_rescue']}, n_call_rescue: {type: 'event', text: 'Llamaste a emergencias y al equipo de rescate interno. Tardan 5 minutos en llegar.', choices: ['c_first_aid_wait', 'c_direct_traffic']}, n_end_ok: {type: 'end', text: 'El operador fue rescatado con heridas leves. La prioridad de seguridad de la escena fue cr√≠tica para el √©xito.'}, n_end_fail: {type: 'end', text: 'El operador sufri√≥ m√°s da√±os por un rescate improvisado o por una falla secundaria (ej. incendio menor).' } }, choices: { c_first_aid: {from: 'n_start', to: 'n_end_fail', effects: {security: -10, time: -5}, desc: 'Intentar primeros auxilios sin asegurar la escena (riesgo de derrumbes/fluidos)'}, c_isolate_power: {from: 'n_start', to: 'n_isolate_power', effects: {procedural: 15, security: 10, time: 5}, desc: 'Priorizar el aislamiento de riesgos (energ√≠a, fluidos) y luego llamar'}, c_call_rescue: {from: 'n_start', to: 'n_call_rescue', effects: {comms: 10, time: 5}, desc: 'Llamar al equipo de rescate y emergencias inmediatamente'}, c_start_extrication: {from: 'n_isolate_power', to: 'n_end_fail', effects: {security: -15, procedural: -10}, desc: 'Intentar sacar al operador sin el equipo de rescate especializado'}, c_wait_rescue: {from: 'n_isolate_power', to: 'n_end_ok', effects: {procedural: 10, security: 5, time: 10}, desc: 'Mantener la seguridad de la escena y esperar al equipo especializado'}, c_first_aid_wait: {from: 'n_call_rescue', to: 'n_end_ok', effects: {empathy: 5, procedural: 5, time: 5}, desc: 'Dar soporte psicol√≥gico y primeros auxilios b√°sicos mientras llega el rescate'}, c_direct_traffic: {from: 'n_call_rescue', to: 'n_end_fail', effects: {procedural: -5}, desc: 'Ir a dirigir el tr√°fico de la planta en lugar de asistir al accidentado'} } }
      ],
      "servicio": [
        { id: 's_acceso_denegado', title: 'Visitante No Autorizado Agresivo', area: 'servicio', difficulty: 'facil', est_time: 4, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Un hombre intenta acceder a un piso restringido sin identificaci√≥n. El sistema de control de acceso lo niega. Se pone visiblemente molesto.', choices: ['c_ask_id', 'c_let_pass', 'c_call_police']}, n_ask_id: {type: 'event', text: 'Le pides que espere e identifique a su contacto interno. Te dice que es un alto ejecutivo y te amenaza con tu trabajo.', choices: ['c_de_escalate', 'c_call_super', 'c_insist_entry']}, n_end_ok: {type: 'end', text: 'El problema se resolvi√≥ sin incidente. La comunicaci√≥n y el respeto al protocolo fueron prioritarios.'}, n_end_fail: {type: 'end', text: 'El individuo forz√≥ la entrada. El protocolo fue roto y se puso en riesgo la seguridad ejecutiva.'} }, choices: { c_ask_id: {from: 'n_start', to: 'n_ask_id', effects: {procedural: 10, security: 5, time: 5}, desc: 'Requerir identificaci√≥n y contacto interno con firmeza y cortes√≠a'}, c_let_pass: {from: 'n_start', to: 'n_end_fail', effects: {security: -20, procedural: -15}, desc: 'Dejarlo pasar por temor a su amenaza'}, c_call_police: {from: 'n_start', to: 'n_ask_id', effects: {comms: 10, time: 10}, desc: 'Llamar a la polic√≠a de inmediato (puede escalar la situaci√≥n innecesariamente)'}, c_de_escalate: {from: 'n_ask_id', to: 'n_end_ok', effects: {empathy: 10, comms: 5, procedural: 5}, desc: 'Usar desescalada verbal, ofrecer ayuda para contactar a su jefe de turno, y mantener la l√≠nea de seguridad'}, c_call_super: {from: 'n_ask_id', to: 'n_end_ok', effects: {procedural: 15, comms: 10, time: 5}, desc: 'Llamar al supervisor de contrato o de seguridad para verificar el permiso'}, c_insist_entry: {from: 'n_ask_id', to: 'n_end_fail', effects: {security: -15, procedural: -10, empathy: -10}, desc: 'Exigirle el acceso y el nombre de su contacto con tono amenazante'} } },
        { id: 's_paquete_sospechoso', title: 'Paquete Olvidado en Lobby', area: 'servicio', difficulty: 'medio', est_time: 6, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Un bolso de mano ha sido dejado solo en el lobby central por 15 minutos. No hay due√±o visible. Alerta de nivel 2.', choices: ['c_approach_check', 'c_isolate_call', 'c_announce']}, n_isolate_call: {type: 'event', text: 'Has establecido un per√≠metro de seguridad inicial y notificaste a tu central y a la polic√≠a.', choices: ['c_wait_expert', 'c_move_package']}, n_end_ok: {type: 'end', text: 'Paquete analizado y declarado seguro. El procedimiento de seguridad y la comunicaci√≥n fueron perfectos. Minimizaste el riesgo.'}, n_end_fail: {type: 'end', text: 'El paquete conten√≠a material pirot√©cnico inestable. Hubo una explosi√≥n menor y p√°nico entre los ocupantes.'} }, choices: { c_approach_check: {from: 'n_start', to: 'n_end_fail', effects: {security: -15, procedural: -10}, desc: 'Acercarse al paquete y revisarlo para ver si tiene etiqueta o contenido'}, c_isolate_call: {from: 'n_start', to: 'n_isolate_call', effects: {procedural: 15, security: 10, comms: 10, time: 5}, desc: 'Establecer per√≠metro, no tocar, activar el protocolo de llamada a central/polic√≠a/desactivaci√≥n'}, c_announce: {from: 'n_start', to: 'n_isolate_call', effects: {empathy: -5, time: -5}, desc: 'Anunciar por el parlante del lobby: "¬øQui√©n olvid√≥ un bolso?" (Advertir al posible atacante)'}, c_wait_expert: {from: 'n_isolate_call', to: 'n_end_ok', effects: {procedural: 10, security: 5}, desc: 'Mantener el per√≠metro y esperar al equipo especializado (polic√≠a/bomberos)'}, c_move_package: {from: 'n_isolate_call', to: 'n_end_fail', effects: {security: -20, procedural: -15}, desc: 'Mover el paquete a un √°rea m√°s segura (alto riesgo de detonaci√≥n)'} } }
      ],
      "salud": [
        { id: 'h_paciente_agresivo', title: 'Alteraci√≥n de Orden en Sala de Espera', area: 'salud', difficulty: 'medio', est_time: 6, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Un paciente en la sala de espera est√° gritando y golpeando objetos, exigiendo ser atendido de inmediato. El resto de los usuarios est√°n asustados.', choices: ['c_intervene_distance', 'c_call_security_chief', 'c_physical_restraint']}, n_intervene_distance: {type: 'event', text: 'Te acercas con una postura abierta y serena, manteniendo una distancia de seguridad. √âl te ignora.', choices: ['c_talk_calmly', 'c_call_paramedics']}, n_talk_calmly: {type: 'event', text: 'Sigues la desescalada verbal y preguntando su nombre. Gana 10 segundos de su atenci√≥n.', choices: ['c_offer_safe_area', 'c_call_paramedics']}, n_end_ok: {type: 'end', text: 'El cliente acepta ser acompa√±ado a un √°rea privada, donde el personal m√©dico de emergencia se hace cargo. Evitaste la confrontaci√≥n y protegiste al p√∫blico. Excelente manejo de crisis.'}, n_end_fail_physical: {type: 'end', text: 'El intento de contenci√≥n f√≠sica causa una reacci√≥n violenta. El cliente y el guardia sufren heridas leves. Falla en el protocolo de desescalada.'}, n_end_fail_delay: {type: 'end', text: 'La demora o la falta de apoyo permiten que el cliente rompa una vitrina antes de ser contenido. Da√±o material y trauma a los testigos.'} }, choices: { c_intervene_distance: {from: 'n_start', to: 'n_intervene_distance', effects: {procedural: 10, security: 5, empathy: 5, time: 5}, desc: 'Acercarse manteniendo la distancia de seguridad (buffer zone)'}, c_call_security_chief: {from: 'n_start', to: 'n_intervene_distance', effects: {procedural: 5, comms: 10, time: 10}, desc: 'Llamar a la central de inmediato y solicitar apoyo, luego acercarse'}, c_physical_restraint: {from: 'n_start', to: 'n_end_fail_physical', effects: {security: -15, empathy: -10}, desc: 'Intentar la contenci√≥n f√≠sica sin t√©cnicas de desescalada ni refuerzos'}, c_talk_calmly: {from: 'n_intervene_distance', to: 'n_talk_calmly', effects: {empathy: 10, comms: 5}, desc: 'Mantener el di√°logo calmado, buscando una causa o distracci√≥n'}, c_call_paramedics: {from: 'n_intervene_distance', to: 'n_end_fail_delay', effects: {time: -10}, desc: 'Solo llamar a enfermer√≠a y esperar que ellos tomen la acci√≥n (delegar la seguridad)'}, c_offer_safe_area: {from: 'n_talk_calmly', to: 'n_end_ok', effects: {procedural: 15, security: 10, empathy: 5}, desc: 'Ofrecer una zona privada para conversar, sac√°ndolo de la vista p√∫blica'} } },
        { id: 'h_intruso_farmacia', title: 'Acceso a Farmacia o Bodega de Drogas', area: 'salud', difficulty: 'alto', est_time: 8, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Un individuo con capucha fuerza la puerta de la farmacia principal. La alarma se activa.', choices: ['c_pursuit', 'c_isolate_and_call', 'c_ask_description']}, n_pursuit: {type: 'event', text: 'El sujeto corre por el pasillo central, lleva una bolsa llena. Grita que tiene un arma.', choices: ['c_calm_talk', 'c_try_catch', 'c_fall_back']}, n_end_ok: {type: 'end', text: 'El intruso fue contenido por la fuerza p√∫blica o desisti√≥ de su acto ante la respuesta profesional. Recuperaci√≥n de la mercanc√≠a. Tarea cumplida.'}, n_end_fail: {type: 'end', text: 'Hubo un herido durante la persecuci√≥n, o el intruso escap√≥ con la mercanc√≠a antes de la captura. Investigaci√≥n interna en curso.'} }, choices: { c_pursuit: {from: 'n_start', to: 'n_pursuit', effects: {time: -5, procedural: 5}, desc: 'Iniciar la b√∫squeda inmediata por las √°reas conocidas'}, c_isolate_and_call: {from: 'n_start', to: 'n_pursuit', effects: {procedural: 10, comms: 5, time: 10}, desc: 'Asegurar salidas y pedir apoyo antes de buscar'}, c_ask_description: {from: 'n_start', to: 'n_pursuit', effects: {comms: 10, time: -5}, desc: 'Preguntar por descripci√≥n y antecedentes al personal'}, c_calm_talk: {from: 'n_pursuit', to: 'n_end_ok', effects: {empathy: 15, procedural: 10, security: 5}, desc: 'Usar voz calmada y ofrecer ayuda sin contacto f√≠sico'}, c_try_catch: {from: 'n_pursuit', to: 'n_end_fail', effects: {security: -10, empathy: -15}, desc: 'Intentar la contenci√≥n f√≠sica sin t√©cnicas de desescalada'}, c_fall_back: {from: 'n_pursuit', to: 'n_end_ok', effects: {security: 15, procedural: 10, time: 5}, desc: 'Retirarse a una zona segura, monitorear la ruta de escape y esperar a la polic√≠a'} } }
      ],
      "mineria": [
        { id: 'm_intruso_bodega', title: 'Intrusi√≥n nocturna en Bodega de Alto Valor', area: 'mineria', difficulty: 'alto', est_time: 10, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Alarma de per√≠metro activada a las 02:00. Las c√°maras muestran un individuo saltando la cerca y dirigi√©ndose a la bodega de repuestos cr√≠ticos.', choices: ['c_send_patrol', 'c_monitor_only', 'c_call_police']}, n_call_police: {type: 'event', text: 'Notificas a la central y a la polic√≠a. El intruso ha entrado en la bodega.', choices: ['c_intercept_discreet', 'c_intercept_soft', 'c_wait_police']}, n_end_ok: {type: 'end', text: 'El intruso fue detenido por la fuerza p√∫blica con el activo recuperado. Se aplic√≥ un excelente control t√°ctico.'}, n_end_fail: {type: 'end', text: 'El intruso escapa con el material de alto valor. Falla en la respuesta perimetral y t√°ctica.'} }, choices: { c_send_patrol: {from: 'n_start', to: 'n_end_fail', effects: {security: -15, procedural: -10}, desc: 'Enviar una patrulla inmediatamente sin coordinar apoyo externo (riesgo de enfrentamiento)'}, c_monitor_only: {from: 'n_start', to: 'n_call_police', effects: {procedural: 5, comms: 5}, desc: 'Mantener la vigilancia y registrar el evento antes de cualquier acci√≥n'}, c_call_police: {from: 'n_start', to: 'n_call_police', effects: {procedural: 15, comms: 10, time: 5}, desc: 'Notificar de inmediato a la polic√≠a y al supervisor, esperando la llegada de refuerzos'}, c_intercept_discreet: {from: 'n_call_police', to: 'n_end_fail', effects: {security: -20, time: -5}, desc: 'Intentar una intercepci√≥n discreta y solitaria dentro de la bodega (alto riesgo de emboscada)'}, c_intercept_soft: {from: 'n_call_police', to: 'n_end_fail', effects: {security: -10}, desc: 'Intentar disuadirlo verbalmente (riesgo si est√° armado)'}, c_wait_police: {from: 'n_call_police', to: 'n_end_ok', effects: {procedural: 10, security: 10, comms: 5}, desc: 'Mantener la vigilancia y esperar a la fuerza p√∫blica'} } },
        { id: 'm_conato_derrame', title: 'Conato de Derrame de Flotaci√≥n', area: 'mineria', difficulty: 'medio', est_time: 6, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Recibes un reporte de una peque√±a fuga en una l√≠nea de flotaci√≥n. El √°rea de la m√°quina est√° cerca de un desag√ºe.', choices: ['c_stop_leak_solo', 'c_fire_protocol', 'c_notify_hsm']}, n_fire_protocol: {type: 'event', text: 'Activaste la alarma local y pediste apoyo. El qu√≠mico no es inflamable pero s√≠ contaminante.', choices: ['c_use_absorbent', 'c_wait_firemen']}, n_notify_hsm: {type: 'event', text: 'El equipo de Seguridad y Medio Ambiente (SSMA) est√° en camino con equipo de contenci√≥n.', choices: ['c_isolate_source', 'c_wait_hsm']}, n_end_ok: {type: 'end', text: 'La fuga fue contenida siguiendo el protocolo. Excelente coordinaci√≥n con SSMA. Da√±o ambiental minimizado.'}, n_end_fail: {type: 'end', text: 'El derrame lleg√≥ al desag√ºe o caus√≥ la detenci√≥n de operaciones por mal manejo inicial.'} }, choices: { c_stop_leak_solo: {from: 'n_start', to: 'n_end_fail', effects: {security: -10, procedural: -5}, desc: 'Intentar cerrar la v√°lvula solo sin conocer el qu√≠mico y sin equipo'}, c_fire_protocol: {from: 'n_start', to: 'n_fire_protocol', effects: {procedural: 5, time: -5}, desc: 'Activar el protocolo de incendio (incorrecto para derrame qu√≠mico)'}, c_notify_hsm: {from: 'n_start', to: 'n_notify_hsm', effects: {procedural: 15, comms: 10, time: 5}, desc: 'Activar el protocolo de derrame y llamar a SSMA/HAZMAT de inmediato'}, c_use_absorbent: {from: 'n_fire_protocol', to: 'n_end_fail', effects: {procedural: -5}, desc: 'Usar absorbente sin EPP ni conocimiento del tipo de qu√≠mico'}, c_wait_firemen: {from: 'n_fire_protocol', to: 'n_end_fail', effects: {time: -10}, desc: 'Esperar a Bomberos sin tomar acci√≥n de contenci√≥n (fuga continua)'}, c_isolate_source: {from: 'n_notify_hsm', to: 'n_end_ok', effects: {procedural: 10, security: 5}, desc: 'Bloquear el paso hacia el desag√ºe y asegurar el √°rea de fuga'} } }
      ],
      "energia": [
        { id: 'e_vandalismo_subestacion', title: 'Vandalismo en Subestaci√≥n Remota', area: 'energia', difficulty: 'alto', est_time: 12, start: 'n_start', nodes: { n_start: {type: 'info', text: 'Sistema de CCTV muestra a 3 individuos entrando al per√≠metro de una subestaci√≥n el√©ctrica remota. Est√°n da√±ando el cercado.', choices: ['c_intervene_direct', 'c_call_police_first', 'c_activate_siren']}, n_call_police_first: {type: 'event', text: 'Llamaste a la polic√≠a de inmediato y notificaste a operaciones. Los sujetos no han llegado a los transformadores.', choices: ['c_warn_loud', 'c_wait_silent']}, n_activate_siren: {type: 'event', text: 'Activaste la sirena y luces. Los sujetos comienzan a correr.', choices: ['c_pursuit_vehicle', 'c_monitor_escape']}, n_end_ok: {type: 'end', text: 'Intrusos detenidos o en fuga total sin causar da√±o a la infraestructura cr√≠tica. Procedimiento de contenci√≥n correcto.'}, n_end_fail: {type: 'end', text: 'Los intrusos cortan la energ√≠a o causan una explosi√≥n al interactuar con el equipo de alto voltaje. Riesgo vital y da√±o a la infraestructura.'} }, choices: { c_intervene_direct: {from: 'n_start', to: 'n_end_fail', effects: {security: -20, procedural: -15}, desc: 'Intervenir solo sin apoyo (riesgo vital por electricidad y agresi√≥n)'}, c_call_police_first: {from: 'n_start', to: 'n_call_police_first', effects: {procedural: 15, comms: 10, time: 5}, desc: 'Notificar a la polic√≠a y operaciones como primera medida'}, c_activate_siren: {from: 'n_start', to: 'n_activate_siren', effects: {time: -5, procedural: 5}, desc: 'Activar sirena y luces de inmediato para disuadir a los intrusos'}, c_warn_loud: {from: 'n_call_police_first', to: 'n_activate_siren', effects: {time: -5}, desc: 'Usar altavoz para advertir su presencia (puede ser contraproducente)'}, c_wait_silent: {from: 'n_call_police_first', to: 'n_end_ok', effects: {procedural: 10, security: 10, comms: 5}, desc: 'Mantener la vigilancia encubierta hasta la llegada de la fuerza p√∫blica'}, c_pursuit_vehicle: {from: 'n_activate_siren', to: 'n_end_fail', effects: {security: -10, time: -10}, desc: 'Perseguir a los intrusos en veh√≠culo sin esperar refuerzos'}, c_monitor_escape: {from: 'n_activate_siren', to: 'n_end_ok', effects: {procedural: 5, security: 5}, desc: 'Monitorear la ruta de escape para dirigir a la polic√≠a, sin entrar en persecuci√≥n'} } }
      ],
      // INICIO NUEVAS SECCIONES SOLICITADAS POR EL USUARIO
      "entidades_portuarias": [
        {
          id: 'p_intruso_muelle',
          title: 'Intrusi√≥n Ilegal en Muelle de Carga',
          area: 'entidades_portuarias',
          difficulty: 'alto',
          est_time: 8,
          start: 'n_start',
          nodes: {
            n_start: {type: 'info', text: 'Un sensor de intrusi√≥n en el muelle A2 se activa. La c√°mara muestra a un individuo intentando acceder a la zona de contenedores de alto valor.', choices: ['c_intercept_solo', 'c_monitor_call', 'c_activate_flood']},
            n_monitor_call: {type: 'event', text: 'Mantienes la vigilancia y notificas a la Armada/Autoridad Portuaria y a tu supervisor. El intruso detecta el movimiento y se oculta.', choices: ['c_wait_force', 'c_patrol_zone']},
            n_end_ok: {type: 'end', text: 'El intruso fue inmovilizado y entregado a la autoridad. Se sigui√≥ el Protocolo ISPS/PBIP rigurosamente. Tarea cumplida con cero riesgo personal.'},
            n_end_fail: {type: 'end', text: 'El intruso escapa o se produce una confrontaci√≥n f√≠sica. Se reporta un aumento de la amenaza a la seguridad de la carga. Falla de protocolo.'}
          },
          choices: {
            c_intercept_solo: {from: 'n_start', to: 'n_end_fail', effects: {security: -20, procedural: -10, time: -5}, desc: 'Intervenir solo en la zona portuaria (Alto riesgo de emboscada)'},
            c_monitor_call: {from: 'n_start', to: 'n_monitor_call', effects: {procedural: 15, comms: 10, security: 5}, desc: 'Monitorear la acci√≥n, asegurar la grabaci√≥n y llamar a la autoridad competente (Protocolo PBIP/ISPS)'},
            c_activate_flood: {from: 'n_start', to: 'n_end_fail', effects: {time: -10, security: -5}, desc: 'Encender todas las luces y sirenas de inmediato (Alertar sin tener control)'},
            c_wait_force: {from: 'n_monitor_call', to: 'n_end_ok', effects: {procedural: 10, security: 10}, desc: 'Mantener la posici√≥n de vigilancia y esperar a la llegada del apoyo armado'},
            c_patrol_zone: {from: 'n_monitor_call', to: 'n_end_fail', effects: {security: -10, time: -5}, desc: 'Iniciar una b√∫squeda activa sin conocer la ubicaci√≥n o intenciones del intruso'}
          }
        }
      ],
      "otros_servicios": [
        {
          id: 'o_pelea_evento',
          title: 'Pelea en Zona VIP de Evento Masivo',
          area: 'otros_servicios',
          difficulty: 'medio',
          est_time: 4,
          start: 'n_start',
          nodes: {
            n_start: {type: 'info', text: 'Dos asistentes VIP comienzan una fuerte discusi√≥n que escala a empujones. La multitud comienza a aglomerarse, creando un riesgo de estampida.', choices: ['c_intervencion_verbal', 'c_llamar_refuerzos', 'c_uso_fuerza']},
            n_verbal: {type: 'event', text: 'Usas t√©cnicas de desescalada verbal, pero una persona intenta golpear a la otra.', choices: ['c_separar', 'c_aislar']},
            n_end_ok: {type: 'end', text: 'Contuviste a las personas sin usar la fuerza innecesaria y restableciste el orden. El manejo de multitudes fue eficaz.'},
            n_end_fail: {type: 'end', text: 'La intervenci√≥n tard√≠a o agresiva provoca que m√°s personas se unan a la pelea. El evento es temporalmente detenido.'}
          },
          choices: {
            c_intervencion_verbal: {from: 'n_start', to: 'n_verbal', effects: {procedural: 10, empathy: 10, time: 5}, desc: 'Intervenir verbalmente para calmar y separar (priorizar desescalada)'},
            c_llamar_refuerzos: {from: 'n_start', to: 'n_verbal', effects: {comms: 10, procedural: 5, time: 10}, desc: 'Llamar de inmediato a refuerzos de control de multitudes y pedir que se acerquen'},
            c_uso_fuerza: {from: 'n_start', to: 'n_end_fail', effects: {security: -10, empathy: -15, time: -5}, desc: 'Usar la fuerza f√≠sica para separarlos de inmediato (sin intentar desescalada)'},
            c_separar: {from: 'n_verbal', to: 'n_end_fail', effects: {security: -5, procedural: -5}, desc: 'Intentar separar a la fuerza con un solo agente (alto riesgo de lesi√≥n)'},
            c_aislar: {from: 'n_verbal', to: 'n_end_ok', effects: {procedural: 15, security: 10}, desc: 'Dirigir a los involucrados a un √°rea de aislamiento con apoyo del equipo'}
          }
        }
      ]
      // FIN NUEVAS SECCIONES SOLICITADAS POR EL USUARIO
    };
  </script>
</body>

</html>