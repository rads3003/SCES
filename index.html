<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Capacitaci√≥n - Guardias de Seguridad</title>
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #141827;
      --bg-card: #1a1f35;
      --accent: #00d9ff;
      --accent-glow: rgba(0, 217, 255, 0.3);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.3;
      animation: float 20s infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translate(0, 0);
        opacity: 0;
      }

      50% {
        opacity: 0.5;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding: 25px;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 53, 0.6) 100%);
      border-radius: 20px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, #ffffff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 5px;
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      color: #070a1a;
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px var(--accent-glow);
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    button.ghost:hover {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--accent);
    }

    /* Estilo para bot√≥n de biometr√≠a activa */
    button#btn-face-analysis.active {
      background: var(--success);
      color: var(--bg-primary);
      box-shadow: 0 0 10px var(--success);
      border: 1px solid var(--success);
    }


    .card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 53, 0.8) 100%);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px var(--accent-glow);
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
    }

    /* Area Selection */
    .area-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .area-card {
      cursor: pointer;
      position: relative;
      overflow: hidden;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .area-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent) 0%, #0080ff 100%);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .area-card.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(0, 128, 255, 0.05) 100%);
    }

    .area-card:hover::before {
      transform: scaleX(1);
    }

    .area-icon {
      font-size: 48px;
      margin-bottom: 15px;
      filter: drop-shadow(0 4px 8px var(--accent-glow));
    }

    .area-card h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--accent);
    }

    /* Scenario Cards */
    .scenarios-grid {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }

    .scenario-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .scenario-card:hover {
      border-color: var(--accent);
    }

    .scenario-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .scenario-card:hover::before {
      transform: scaleY(1);
    }

    .difficulty-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .difficulty-facil {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .difficulty-medio {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .difficulty-alto {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    /* Game View */
    .game-container {
      min-height: 500px;
    }

    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, transparent 100%);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
    }

    /* Estilos del M√≥dulo Biometr√≠a */
    .face-analysis-module {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .face-analysis-module video,
    .face-analysis-module canvas {
      width: 120px;
      height: 90px;
      background: var(--bg-secondary);
      border: 2px solid var(--danger);
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
      transform: scaleX(-1);
      /* Simular espejo */
      transition: all 0.3s ease;
    }

    .face-analysis-module.active video,
    .face-analysis-module.active canvas {
      border-color: var(--success);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
    }

    .timer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      padding: 10px 20px;
      background: rgba(0, 217, 255, 0.1);
      border-radius: 8px;
    }

    .timer.warning {
      color: var(--warning);
      background: rgba(245, 158, 11, 0.1);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.6;
      }
    }

    .node-content {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 25px;
      border-left: 4px solid var(--accent);
      position: relative;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .node-text {
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .choices-grid {
      display: grid;
      gap: 15px;
    }

    .choice-btn {
      padding: 20px;
      text-align: left;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 53, 0.6) 100%);
      border: 2px solid var(--border);
      border-radius: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      /* FORZAR LETRAS BLANCAS PARA MEJOR VISUALIZACION */
      color: var(--text-primary);
    }

    .choice-btn * {
      /* Aplicar tambi√©n a sub-elementos para garantizar el contraste */
      color: var(--text-primary) !important;
    }

    .choice-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .choice-btn:hover {
      border-color: var(--accent);
      transform: translateX(10px);
    }

    .choice-btn:hover::before {
      opacity: 0.1;
    }

    .choice-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .choice-effects {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .effect-tag {
      padding: 3px 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 12px;
    }

    /* Sobrescribir el color del texto del tag solo donde sea necesario */
    .effect-positive {
      color: var(--success) !important;
      background: rgba(16, 185, 129, 0.1);
    }

    .effect-negative {
      color: var(--danger) !important;
      background: rgba(239, 68, 68, 0.1);
    }

    /* Feedback Section */
    .feedback-card {
      margin-top: 20px;
      padding: 20px;
      /* Color por defecto (positivo) */
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
      border-left: 4px solid var(--success);
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .feedback-card.warning {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
      border-left-color: var(--danger);
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 20px;
      height: fit-content;
    }

    .user-panel {
      margin-bottom: 20px;
    }

    .user-input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      margin-top: 10px;
      /* Added spacing for new fields */
    }

    /* Override for first input */
    #user-name {
      margin-top: 10px;
      /* To separate from h3 */
    }

    .user-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(0, 217, 255, 0.05);
    }

    .dimensions-list {
      display: grid;
      gap: 12px;
      margin-top: 15px;
    }

    .dimension-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .dimension-item:hover {
      background: rgba(0, 217, 255, 0.05);
    }

    .dimension-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .dimension-value {
      font-weight: 700;
      font-size: 18px;
      color: var(--accent);
    }

    .progress-bar-container {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.05) 0%, transparent 100%);
      border-radius: 12px;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, #0080ff 100%);
      border-radius: 999px;
      transition: width 0.5s ease;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    /* Report View */
    .report-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .report-header {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, transparent 100%);
      border-radius: 16px;
      margin-bottom: 30px;
    }

    .final-score {
      font-size: 64px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, #0080ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 20px 0;
    }

    .report-section {
      margin-bottom: 25px;
    }

    .report-section h3 {
      color: var(--accent);
      margin-bottom: 15px;
      font-size: 20px;
    }

    .action-list {
      display: grid;
      gap: 10px;
    }

    .action-item {
      padding: 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: static;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 20px;
      }

      .header-actions {
        flex-wrap: wrap;
      }

      .area-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="particles" id="particles"></div>

  <div id="notification-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="color: var(--accent); margin-bottom: 15px;"></h3>
      <p id="modal-message" style="color: var(--text-primary); margin-bottom: 20px;"></p>
      <button class="primary" onclick="hideModal()">Aceptar</button>
    </div>
  </div>


  <div class="container">
    <header>
      <div class="logo">üõ°Ô∏è</div>
      <div style="flex: 1;">
        <h1>Simulador de aplicaci√≥n de protocolos para Eventos Cr√≠ticos</h1>
        <div class="subtitle">Entrena decisiones cr√≠ticas con escenarios realistas y feedback inmediato</div>
      </div>
      <div class="header-actions">
        <button class="ghost" id="btn-face-analysis">üëÅÔ∏è Biometr√≠a Facial</button>
        <button class="ghost" id="btn-tts">üîä Voz</button>
        <button class="ghost" id="btn-admin">‚öôÔ∏è Admin</button>
        <button class="ghost" id="btn-reset">‚ôªÔ∏è Reset</button>
      </div>
    </header>

    <div class="main-layout">
      <main>
        <div id="view-area" class="card">
          <h2 style="margin-bottom: 20px;">Selecciona tu √°rea de desempe√±o</h2>
          <div class="area-grid">
            <div class="area-card card" data-area="comercial" tabindex="0">
              <div class="area-icon">üè™</div>
              <h3>Comercial / Retail</h3>
              <p style="color: var(--text-secondary);">Mall, supermercados y centros comerciales. Enfoque en atenci√≥n al
                p√∫blico, prevenci√≥n de hurtos y emergencias.</p>
            </div>
            <div class="area-card card" data-area="industrial" tabindex="0">
              <div class="area-icon">üè≠</div>
              <h3>Industrial</h3>
              <p style="color: var(--text-secondary);">Plantas industriales - seguridad de per√≠metro, maquinaria,
                riesgos qu√≠micos y emergencias laborales.</p>
            </div>
            <div class="area-card card" data-area="servicio" tabindex="0">
              <div class="area-icon">üè¢</div>
              <h3>Servicio / Corporativo</h3>
              <p style="color: var(--text-secondary);">Edificios de oficinas, corporativos y de servicios. Enfoque en
                control de acceso, paquetes sospechosos y protecci√≥n ejecutiva.</p>
            </div>
            <div class="area-card card" data-area="salud" tabindex="0">
              <div class="area-icon">üè•</div>
              <h3>Salud / Hospitalario</h3>
              <p style="color: var(--text-secondary);">Cl√≠nicas, laboratorios y hospitales. Enfoque en control de
                visitas, usuarios, manejo de personas agresivas y seguridad de zonas sensibles.</p>
            </div>
            <div class="area-card card" data-area="mineria" tabindex="0">
              <div class="area-icon">‚õèÔ∏è</div>
              <h3>Miner√≠a</h3>
              <p style="color: var(--text-secondary);">Faenas y sitios de extracci√≥n remotos. Enfoque en seguridad
                perimetral, control de ingreso, materiales de alto valor y respuesta a accidentes con maquinaria.</p>
            </div>
            <div class="area-card card" data-area="energia" tabindex="0">
              <div class="area-icon">‚ö°</div>
              <h3>Energ√≠a</h3>
              <p style="color: var(--text-secondary);">Subestaciones, plantas de poder e infraestructura cr√≠tica.
                Enfoque en prevenci√≥n de sabotaje, control de acceso y manejo de emergencias.</p>
            </div>
            <div class="area-card card" data-area="entidades_portuarias" tabindex="0">
              <div class="area-icon">üö¢</div>
              <h3>Entidades Portuarias</h3>
              <p style="color: var(--text-secondary);">Terminales mar√≠timos, zonas de aduana y log√≠stica de carga.
                Enfoque en control de acceso, seguridad perimetral y manejo de carga cr√≠tica.</p>
            </div>
            <div class="area-card card" data-area="otros_servicios" tabindex="0">
              <div class="area-icon">üìπ</div>
              <h3>CCTV / An√°lisis de Im√°genes</h3>
              <p style="color: var(--text-secondary);">Monitoreo por CCTV, detecci√≥n temprana de incidentes, an√°lisis de comportamiento,
                seguimiento multic√°mara y apoyo a la toma de decisiones operativas.</p>
            </div>
          </div>

          <div id="scenarios-container" style="display: none; margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3>Escenarios disponibles</h3>
              <button class="primary" id="btn-random">üé≤ Iniciar Aleatorio</button>
            </div>
            <div class="scenarios-grid" id="scenarios-list"></div>
          </div>
        </div>

        <div id="view-play" style="display: none; position: relative;">
          <div id="face-analysis-module" class="face-analysis-module" style="display: none;">
            <canvas id="face-canvas" style="position: absolute;"></canvas>
            <video id="face-video" style="display: block;"></video>
            <small id="face-status" style="margin-top: 5px; color: var(--text-secondary); font-size: 10px;"></small>
          </div>
          <div class="card game-container">
            <div class="scenario-header">
              <div>
                <h2 id="scenario-title">T√≠tulo del Escenario</h2>
                <div class="subtitle" id="scenario-meta">Meta info</div>
              </div>
              <div class="timer-group" style="display: flex; gap: 15px; align-items: center;">
                <div class="timer" id="timer">
                  <span>‚è±Ô∏è</span>
                  <span id="timer-value">00:00</span>
                </div>

                <div id="tension-meter"
                  style="width: 150px; height: 40px; border: 1px solid var(--border); border-radius: 8px; padding: 5px; background: var(--bg-secondary); transition: all 0.3s ease;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">‚ö° Tensi√≥n Operacional
                  </div>
                  <div class="progress-bar" style="height: 10px; margin-top: 0;">
                    <div id="tension-fill" class="progress-fill"
                      style="width: 0%; background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="node-content">
              <div class="node-text" id="node-text"></div>
              <div id="node-media"></div>
            </div>

            <div class="choices-grid" id="choices"></div>
          </div>

          <div class="card feedback-card" id="feedback-card" style="display: none;">
            <h3 style="margin-bottom: 10px;">üìã Feedback Inmediato</h3>
            <div id="immediate-feedback"></div>
            <div style="margin-top: 10px; color: var(--text-secondary);">
              Acciones realizadas: <strong id="actions-count" style="color: var(--accent);">0</strong>
            </div>
          </div>
        </div>

        <div id="view-report" style="display: none;">
          <div class="report-container">
            <div class="card report-header">
              <h2>üèÜ Reporte Final</h2>
              <div class="final-score" id="final-score">85%</div>
              <div class="subtitle">Excelente desempe√±o en este escenario</div>
            </div>

            <div class="card report-section">
              <h3>üìä Dimensiones Evaluadas</h3>
              <div id="report-dimensions"></div>
            </div>

            <div class="card report-section">
              <h3>üìù Acciones Registradas</h3>
              <div class="action-list" id="report-actions"></div>
            </div>

            <div class="card report-section">
              <h3>üí° Retroalimentaci√≥n</h3>
              <div id="report-feedback"></div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px;">
              <button class="ghost" id="btn-export-json">üì• Descargar JSON</button>
              <button class="ghost" id="btn-print">üñ®Ô∏è Imprimir PDF</button>
              <button class="primary" id="btn-replay" style="margin-left: auto;">üîÑ Reintentar Escenario</button>
            </div>
          </div>
        </div>
      </main>

      <aside class="sidebar">
        <div class="card user-panel">
          <h3 style="margin-bottom: 15px;">üë§ Usuario</h3>
          <input type="text" class="user-input" id="user-name" placeholder="Ingresa tu Nombre">
          <input type="text" class="user-input" id="user-rut" placeholder="Ingresa tu RUT (Ej: 12.345.678-9)">
          <input type="text" class="user-input" id="user-facility" placeholder="Instalaci√≥n/Sede">

          <div style="margin-top: 20px;">
            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 10px;">Sesiones guardadas:
              <strong id="sessions-count" style="color: var(--accent);">0</strong>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="ghost" id="btn-save-session" style="flex: 1;">üíæ Guardar</button>
              <button class="ghost" id="btn-load-session" style="flex: 1;">üìÇ Cargar</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 15px;">üìä Dimensiones</h3>
          <div class="dimensions-list">
            <div class="dimension-item">
              <span class="dimension-label">Procedimental</span>
              <span class="dimension-value" id="dim-procedural">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Seguridad</span>
              <span class="dimension-value" id="dim-security">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Comunicaciones</span>
              <span class="dimension-value" id="dim-comms">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Tiempo</span>
              <span class="dimension-value" id="dim-time">0</span>
            </div>
            <div class="dimension-item">
              <span class="dimension-label">Empat√≠a</span>
              <span class="dimension-value" id="dim-empathy">0</span>
            </div>
          </div>

          <div class="progress-bar-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="font-size: 14px;">Progreso Total</span>
              <span style="font-weight: 600; color: var(--accent);" id="partial-score">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div class="card" id="admin-panel" style="display: none; margin-top: 20px;">
          <h3 style="margin-bottom: 15px;">‚öôÔ∏è Panel de Administraci√≥n</h3>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
            Edita o pega JSON de escenarios personalizados
          </p>
          <textarea id="admin-json" class="user-input" style="height: 200px; font-family: monospace; font-size: 12px;" placeholder="{ ... }"></textarea>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="primary" id="btn-load-json" style="flex: 1;">üì§ Cargar JSON</button>
            <button class="ghost" id="btn-export-json-admin" style="flex: 1;">üì• Exportar</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Configuraci√≥n
    const DIMENSIONS = ['procedural', 'security', 'comms', 'time', 'empathy'];
    const WEIGHTS = {procedural: 0.4, security: 0.3, comms: 0.15, time: 0.1, empathy: 0.05};
    
    // Configuraci√≥n de Reacci√≥n T√°ctica (en milisegundos)
    const MAX_REACTION_TIME = 20000; // 20 segundos para vacilaci√≥n
    const MIN_REACTION_TIME = 3000;  // 3 segundos para impulsividad

    // --- CONFIGURACI√ìN DE UMBRAL T√ÅCTICO REFINADA ---
    // El umbral de falla cr√≠tica se mantiene en 2.
    const CRITICAL_SECURITY_THRESHOLD = 2; 
    const GENERIC_CRITICAL_FAIL_NODE = 'n_end_critical_fail';
    const MINIMUM_PASSING_SCORE = 60; // Umbral de porcentaje total (60%)
    const MISSION_TOTAL_FAIL_NODE = 'n_end_mission_fail'; 
    // --------------------------------------------------------------------------
    
    // Estado del juego
    let gameState = {
      currentArea: null,
      currentScenario: null,
      currentNode: null,
      dimensions: {procedural: 0, security: 0, comms: 0, time: 0, empathy: 0},
      actions: [],
      startTime: null,
      timerInterval: null,
      score: 0,
      tensionLevel: 0, 
      nodeLoadTime: 0, 
      faceAnalysisActive: false
    };
    
    // --- L√≥gica del Modal de Notificaci√≥n ---
    function showModal(title, message) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        document.getElementById('notification-modal').classList.add('active');
    }

    function hideModal() {
        document.getElementById('notification-modal').classList.remove('active');
    }

    // Funciones de utilidad de la interfaz
    function switchView(viewId) {
        document.getElementById('view-area').style.display = 'none';
        document.getElementById('view-play').style.display = 'none';
        document.getElementById('view-report').style.display = 'none';
        
        // Esconder feedback al cambiar de vista
        document.getElementById('feedback-card').style.display = 'none';

        const targetView = document.getElementById(viewId);
        if (targetView) {
            targetView.style.display = 'block';
        }
    }
    
    function updateTimerDisplay() {
        if (!gameState.startTime) return;
        const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
        const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const seconds = String(elapsed % 60).padStart(2, '0');
        const timerElement = document.getElementById('timer-value');
        timerElement.textContent = `${minutes}:${seconds}`;
        
        // Alerta visual de tiempo
        const timerContainer = document.getElementById('timer');
        if (elapsed > 300) { // 5 minutos de advertencia
             timerContainer.classList.add('warning');
        } else {
             timerContainer.classList.remove('warning');
        }
    }

    function startTimer() {
        clearInterval(gameState.timerInterval);
        gameState.startTime = Date.now();
        gameState.timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    function stopTimer() {
        clearInterval(gameState.timerInterval);
    }
    
    function updateDimensionsDisplay() {
        DIMENSIONS.forEach(dim => {
            document.getElementById(`dim-${dim}`).textContent = gameState.dimensions[dim];
        });
        document.getElementById('actions-count').textContent = gameState.actions.length;
        
        const currentScore = calculatePartialScore();
        document.getElementById('partial-score').textContent = `${currentScore}%`;
        document.getElementById('progress-bar').style.width = `${currentScore}%`;
    }

    // Funci√≥n para actualizar el medidor de tensi√≥n
    function updateTensionDisplay() {
        const maxTension = 100; // M√°ximo de 100% de tensi√≥n
        let tension = Math.min(maxTension, Math.max(0, gameState.tensionLevel));

        // La tensi√≥n se calcula sobre 100%
        const percentage = (tension / maxTension) * 100;

        const tensionFill = document.getElementById('tension-fill');
        const tensionMeter = document.getElementById('tension-meter');
        if (tensionFill) {
            tensionFill.style.width = `${percentage}%`;
            
            // Efecto visual de alto riesgo si la tensi√≥n es > 70
            if (tension > 70) {
                tensionMeter.style.borderColor = 'var(--danger)';
                tensionMeter.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.6)';
            } else if (tension > 40) {
                tensionMeter.style.borderColor = 'var(--warning)';
                tensionMeter.style.boxShadow = 'none';
            } else {
                tensionMeter.style.borderColor = 'var(--border)';
                tensionMeter.style.boxShadow = 'none';
            }
        }
    }

    // Funci√≥n para manejar la activaci√≥n de la c√°mara y la simulaci√≥n
    async function toggleFaceAnalysis() {
        const btn = document.getElementById('btn-face-analysis');
        const module = document.getElementById('face-analysis-module');
        const video = document.getElementById('face-video');
        const status = document.getElementById('face-status');

        if (!gameState.faceAnalysisActive) {
            // Simulaci√≥n de solicitud de permisos
            try {
                // Intentar obtener el stream (esto activar√° el cuadro de di√°logo de permisos del navegador)
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.play();
                module.style.display = 'flex';
                module.classList.add('active');
                btn.classList.add('active');
                btn.textContent = 'üëÅÔ∏è Biometr√≠a ACTIVA';
                status.textContent = 'An√°lisis de Tensi√≥n ON';
                gameState.faceAnalysisActive = true;
                showModal('‚úÖ M√≥dulo de Biometr√≠a Activado', 'El sistema est√° leyendo sus **microexpresiones faciales**. Esto afectar√° directamente su puntuaci√≥n de **Tensi√≥n Operacional** y **Procedimiento**.');
            } catch (err) {
                // Si el usuario niega o hay un error, simulamos la activaci√≥n sin el video real
                module.style.display = 'flex';
                module.classList.add('active');
                btn.classList.add('active');
                btn.textContent = 'üëÅÔ∏è Biometr√≠a (Simulada)';
                status.textContent = 'ERROR: No Camera. Simulaci√≥n ON';
                gameState.faceAnalysisActive = true;
                showModal('‚ö†Ô∏è M√≥dulo de Biometr√≠a (Simulado)', 'El sistema de biometr√≠a se ha activado en modo simulaci√≥n debido a un bloqueo de c√°mara. Su **Tensi√≥n Operacional** seguir√° siendo penalizada.');
            }
        } else {
            // Desactivar
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            module.style.display = 'none';
            module.classList.remove('active');
            btn.classList.remove('active');
            btn.textContent = 'üëÅÔ∏è Biometr√≠a Facial';
            status.textContent = '';
            gameState.faceAnalysisActive = false;
        }
    }

    function calculatePartialScore() {
        let totalWeightedScore = 0;
        // Max score for each dimension is 20 points.
        // Formula: (procedural*0.4) + (security*0.3) + (comms*0.15) + (time*0.1) + (empathy*0.05)
        // If all are 20: (20 * 0.4) + (20 * 0.3) + (20 * 0.15) + (20 * 0.1) + (20 * 0.05) = 20
        DIMENSIONS.forEach(dim => {
            totalWeightedScore += gameState.dimensions[dim] * WEIGHTS[dim];
        });
        
        // Normalize the score to a 0-100 range, capping at 100.
        // We use a factor of 5 to scale max 20 points to 100%.
        const normalizedScore = Math.min(100, Math.max(0, totalWeightedScore * 5));
        return Math.round(normalizedScore);
    }

    // --- L√≥gica del Juego ---

    // Definici√≥n de Escenarios, Nodos y Opciones
    const SCENARIOS = {
      comercial: [
        // INICIO: Escenarios Agregados por Analista de Inteligencia (OCTO) - 5 Escenarios
        {
          id: 'psiquiatrica',
          title: 'Manejo de Persona con Descompensaci√≥n Psiqui√°trica', // Escenario 1: Solicitado como prioridad
          area: 'Comercial/Retail',
          difficulty: 'alto',
          est_time: 15,
          start: 'n_start_psiquiatrica' 
        },
        {
          id: 'asalto_armado',
          title: 'Asalto a Mano Armada en Tienda', // Escenario 2
          area: 'Comercial/Retail',
          difficulty: 'alto',
          est_time: 10,
          start: 'n_start_hurto' // Se utiliza un nodo existente como placeholder para mantener la funcionalidad m√≠nima
        },
        {
          id: 'evacuacion_emergencia',
          title: 'Evacuaci√≥n de Emergencia por Amenaza', // Escenario 3
          area: 'Comercial/Retail',
          difficulty: 'medio',
          est_time: 10,
          start: 'n_start_hurto' // Se utiliza un nodo existente como placeholder
        },
        {
          id: 'manifestacion_hostil',
          title: 'Manifestaci√≥n Hostil en Entrada Principal', // Escenario 4
          area: 'Comercial/Retail',
          difficulty: 'alto',
          est_time: 20,
          start: 'n_start_hurto' // Se utiliza un nodo existente como placeholder
        },
        {
          id: 'fraude_interno',
          title: 'Detecci√≥n de Fraude o Colusi√≥n Interna', // Escenario 5
          area: 'Comercial/Retail',
          difficulty: 'medio',
          est_time: 5,
          start: 'n_start_hurto' // Se utiliza un nodo existente como placeholder
        },
        // FIN: Escenarios Agregados por Analista de Inteligencia (OCTO) - 5 Escenarios
        {
          id: 'hurto_flagrante',
          title: 'Hurto Flagrante con Resistencia', // Escenario Original
          area: 'Comercial/Retail',
          difficulty: 'medio',
          est_time: 5,
          start: 'n_start_hurto'
        }
      ],
      industrial: [
        {
          id: 'robo_vehiculo',
          title: 'Intento de Robo de Carga y Veh√≠culo',
          area: 'Industrial/Log√≠stico',
          difficulty: 'alto',
          est_time: 10,
          start: 'n_start_robo'
        }
      ],
      servicio: [
        {
          id: 'acceso_no_autorizado',
          title: 'Acceso No Autorizado y Hostil',
          area: 'Corporativo/Oficinas',
          difficulty: 'medio',
          est_time: 5,
          start: 'n_start_acceso'
        }
      ],
      publico_abierto: [
        {
          id: 'pelea_masiva',
          title: 'Pelea Masiva en Evento',
          area: 'Espacio P√∫blico Abierto',
          difficulty: 'alto',
          est_time: 15,
          start: 'n_start'
        }
      ],
      salud: [],
      mineria: [],
      energia: [],
      entidades_portuarias: [],
      otros_servicios: []
    };

    const NODES = {
      // --- NODO DE FALLA CR√çTICA (A√ëADIDO) ---
      [GENERIC_CRITICAL_FAIL_NODE]: {
        type: 'end',
        text: 'üö® Falla Cr√≠tica de Protocolo: Las acciones tomadas comprometieron la seguridad o el procedimiento a un nivel inaceptable, resultando en un incidente grave y finalizando la simulaci√≥n. **No cumpliste con las pautas m√≠nimas de seguridad operativa.**',
      },
      // --- NODO DE FALLA POR PORCENTAJE (NUEVO) ---
      [MISSION_TOTAL_FAIL_NODE]: {
        type: 'end',
        text: 'üìâ Misi√≥n Incompleta: Aunque no cometiste una falla cr√≠tica inmediata, la acumulaci√≥n de decisiones sub√≥ptimas y la baja puntuaci√≥n final (menos del 60%) indican que el caso no se resolvi√≥ de manera eficiente o segura. **Se requiere reentrenamiento t√°ctico.**',
      },
      // ----------------------------------------

      // NODOS PARA ESPACIO P√öBLICO
      n_start: {
        type: 'start',
        text: 'Una pelea entre dos facciones ha iniciado. Es vital contener la situaci√≥n sin que escale. ¬øCu√°l es su primera acci√≥n?',
        choices: ['c_intervencion_verbal', 'c_llamar_refuerzos', 'c_uso_fuerza']
      },
      n_verbal: {
        type: 'continue',
        text: 'Su intervenci√≥n verbal ha captado la atenci√≥n, pero las personas siguen confront√°ndose y la tensi√≥n es alta. Debe separarlas para aislarlas y evitar da√±os a terceros.',
        choices: ['c_separar', 'c_aislar']
      },
      n_end_ok: {
        type: 'end',
        text: 'Contuviste a las personas sin usar la fuerza innecesaria y restableciste el orden. El manejo de multitudes fue eficaz.'
      },
      n_end_fail: {
        type: 'end',
        text: 'La intervenci√≥n tard√≠a o agresiva provoca que m√°s personas se unan a la pelea. El evento es temporalmente detenido.'
      },
      // NODOS PARA INDUSTRIAL/LOG√çSTICO
      n_start_robo: {
        type: 'start',
        text: 'Tres individuos armados intentan forzar un cami√≥n de alto valor. Usted est√° solo y sin ser detectado. ¬øCu√°l es su acci√≥n inicial?',
        choices: ['c_activar_alarma_panico', 'c_comunicar_central', 'c_confrontar_directo']
      },
      n_evaluar_riesgo: {
        type: 'continue',
        text: 'Ha alertado a la central. Debe esperar refuerzos. Los sujetos est√°n a punto de abrir el cami√≥n. ¬øIntenta una distracci√≥n o mantiene la posici√≥n?',
        choices: ['c_distraccion', 'c_mantener_posicion']
      },
      n_end_ok_robo: {
        type: 'end',
        text: 'El plan de contenci√≥n y comunicaci√≥n con la central fue eficaz. La polic√≠a intercept√≥ a los asaltantes sin da√±os al personal ni p√©rdida de carga.'
      },
      n_end_fail_robo: {
        type: 'end',
        text: 'La confrontaci√≥n directa caus√≥ un enfrentamiento armado. Los asaltantes escaparon y un guardia result√≥ herido.'
      },
      // NODOS PARA COMERCIAL/RETAIL
      n_start_hurto: {
        type: 'start',
        text: 'El sujeto interceptado por hurto lo empuja. Debe contener la huida de la persona y asegurar la mercanc√≠a sin escalamiento innecesario. ¬øCu√°l es su primera acci√≥n?',
        choices: ['c_retener_fisico', 'c_activar_alarma_interna', 'c_perseguir_exterior']
      },
      n_contencion: {
        type: 'continue',
        text: 'La persona intenta zafarse con violencia. Debe controlarla sin causar lesiones. ¬øQu√© t√©cnica usa?',
        choices: ['c_control_articular', 'c_uso_bast√≥n']
      },
      n_end_ok_hurto: {
        type: 'end',
        text: 'El sujeto fue contenido con la fuerza m√≠nima necesaria y puesto a disposici√≥n policial. Se recuper√≥ la mercanc√≠a.'
      },
      n_end_fail_hurto: {
        type: 'end',
        text: 'El uso excesivo de fuerza gener√≥ un incidente legal por lesiones. El sujeto fue detenido, pero la empresa enfrenta una demanda.'
      },
      // NODOS ESPEC√çFICOS PARA MANEJO DE CRISIS PSIQUI√ÅTRICA
      n_start_psiquiatrica: {
        type: 'start',
        text: 'Un individuo presenta descompensaci√≥n psiqui√°trica en el √°rea de cajas, gritando y causando p√°nico. La prioridad es la seguridad de terceros y la desescalada. ¬øQu√© hace primero?',
        choices: ['c_desescalada_verbal', 'c_contencion_fisica_rapida', 'c_aislamiento_zona', 'c_llamar_policia_medica']
      },
      // NUEVO NODO: Evaluaci√≥n de Riesgo y Desescalada Activa (Paso 2)
      n_aislamiento_exitoso: { 
        type: 'continue',
        text: 'Ha conseguido aislar la zona y notificar a la central/emergencias. Sin embargo, el individuo sigue agitado y comienza a mostrar signos de paranoia, acerc√°ndose al per√≠metro de seguridad. ¬øCu√°l es su estrategia de desescalada verbal inmediata?',
        choices: ['c_mantener_distancia_dialogo', 'c_ofrecer_agua_lugar_seguro', 'c_acercarse_ayudar_fisico', 'c_amenaza_uso_fuerza']
      },
      // NUEVO NODO: Coordinaci√≥n y Cierre de Caso (Paso 3)
      n_desescalada_avanzada: {
        type: 'continue',
        text: 'La persona ha cedido ligeramente y se ha retirado a un punto de encuentro, aunque sigue reacia a cooperar. Los servicios de emergencia (SAMU/Polic√≠a) han llegado al exterior. ¬øCu√°l es su acci√≥n procedimental final?',
        choices: ['c_coordinar_emergencia', 'c_solicitar_identificacion', 'c_relajar_perimetro']
      },
      n_end_ok_psiquiatrica: {
        type: 'end',
        text: 'Excelente manejo. La desescalada verbal, el aislamiento temporal y la coordinaci√≥n con los servicios de emergencia especializados permitieron una resoluci√≥n exitosa del caso, minimizando el riesgo para el cliente y terceros.'
      },
      n_end_fail_psiquiatrica: {
        type: 'end',
        text: 'El uso de la fuerza o la exposici√≥n al p√∫blico escal√≥ la crisis, resultando en lesiones o un da√±o grave a la imagen de la empresa. El manejo fue inadecuado.'
      },
      // NODOS PARA CORPORATIVO/OFICINAS
      n_start_acceso: {
        type: 'start',
        text: 'El exempleado est√° visiblemente enojado y amenaza al personal. La prioridad es el personal. ¬øC√≥mo procede con la contenci√≥n?',
        choices: ['c_desescalada_empatica', 'c_solicitar_policia', 'c_bloqueo_fisico']
      },
      n_dialogo: {
        type: 'continue',
        text: 'El di√°logo ha fallado y el sujeto intenta pasar por la fuerza. La polic√≠a ya fue notificada, pero tardar√° 5 minutos. ¬øQu√© hace?',
        choices: ['c_barrera_fisica', 'c_replegarse']
      },
      n_end_ok_acceso: {
        type: 'end',
        text: 'El sujeto fue contenido sin da√±o f√≠sico al personal ni a la propiedad. El protocolo de desescalada y la respuesta policial funcionaron.'
      },
      n_end_fail_acceso: {
        type: 'end',
        text: 'El sujeto logr√≥ acceder a √°reas restringidas, causando da√±os a la propiedad y exponiendo informaci√≥n sensible.'
      }
    };

    const CHOICES = {
      // OPCIONES PARA ESPACIO P√öBLICO
      c_intervencion_verbal: {
        from: 'n_start',
        to: 'n_verbal',
        effects: {
          procedural: 10,
          empathy: 10,
          time: 5
        },
        desc: 'Intervenir verbalmente para calmar y separar (priorizar desescalada)'
      },
      c_llamar_refuerzos: {
        from: 'n_start',
        to: 'n_verbal',
        effects: {
          comms: 10,
          procedural: 5,
          time: 10
        },
        desc: 'Llamar de inmediato a refuerzos de control de multitudes y pedir que se acerquen'
      },
      c_uso_fuerza: {
        from: 'n_start',
        to: 'n_end_fail',
        effects: {
          security: -10,
          empathy: -15,
          time: -5
        },
        desc: 'Usar la fuerza f√≠sica para separarlos de inmediato (sin intentar desescalada)'
      },
      c_separar: {
        from: 'n_verbal',
        to: 'n_end_fail',
        effects: {
          security: -5,
          procedural: -5
        },
        desc: 'Intentar separar a la fuerza con un solo agente (alto riesgo de lesi√≥n)'
      },
      c_aislar: {
        from: 'n_verbal',
        to: 'n_end_ok',
        effects: {
          security: 10,
          empathy: 5
        },
        desc: 'Usar comunicaci√≥n para que las partes en conflicto se retiren a un √°rea segura para mediar.'
      },
      // OPCIONES PARA INDUSTRIAL/LOG√çSTICO
      c_activar_alarma_panico: {
        from: 'n_start_robo',
        to: 'n_end_ok_robo',
        effects: {
          comms: 15,
          security: 10
        },
        desc: 'Activar alarma silenciosa/p√°nico para alertar a central y polic√≠a'
      },
      c_comunicar_central: {
        from: 'n_start_robo',
        to: 'n_evaluar_riesgo',
        effects: {
          comms: 10,
          procedural: 5
        },
        desc: 'Informar a la central de monitoreo con detalles de la situaci√≥n y esperar instrucciones'
      },
      c_confrontar_directo: {
        from: 'n_start_robo',
        to: 'n_end_fail_robo',
        effects: {
          security: -20,
          time: -10
        },
        desc: 'Intentar la confrontaci√≥n directa e inmediata para detener el robo'
      },
      c_distraccion: {
        from: 'n_evaluar_riesgo',
        to: 'n_end_fail_robo',
        effects: {
          security: -15,
          time: -5
        },
        desc: 'Intentar una distracci√≥n (ej. encender luces) para que se retiren, pero arriesgando su posici√≥n.'
      },
      c_mantener_posicion: {
        from: 'n_evaluar_riesgo',
        to: 'n_end_ok_robo',
        effects: {
          security: 10,
          procedural: 10
        },
        desc: 'Mantener el ocultamiento, seguir informando la situaci√≥n y esperar el apoyo policial.'
      },
      // OPCIONES PARA COMERCIAL/RETAIL (Hurto)
      c_retener_fisico: {
        from: 'n_start_hurto',
        to: 'n_contencion',
        effects: {
          security: 5,
          time: 5
        },
        desc: 'Utilizar una retenci√≥n f√≠sica controlada para impedir la huida.'
      },
      c_activar_alarma_interna: {
        from: 'n_start_hurto',
        to: 'n_end_ok_hurto',
        effects: {
          comms: 10
        },
        desc: 'Priorizar activar alarma para que otro personal (o polic√≠a) intercepte la salida.'
      },
      c_perseguir_exterior: {
        from: 'n_start_hurto',
        to: 'n_end_fail_hurto',
        effects: {
          security: -10
        },
        desc: 'Perseguir al sujeto fuera de la tienda (alto riesgo de abandono de puesto y confrontaci√≥n en v√≠a p√∫blica).'
      },
      c_control_articular: {
        from: 'n_contencion',
        to: 'n_end_ok_hurto',
        effects: {
          security: 15,
          procedural: 10
        },
        desc: 'Aplicar t√©cnica de control articular para inmovilizar con fuerza m√≠nima.'
      },
      c_uso_bast√≥n: {
        from: 'n_contencion',
        to: 'n_end_fail_hurto',
        effects: {
          security: -15,
          empathy: -15
        },
        desc: 'Usar el bast√≥n de servicio para forzar la detenci√≥n (alto riesgo de escalamiento y lesi√≥n).'
      },
      // OPCIONES PARA CRISIS PSIQUI√ÅTRICA (Paso 1)
      c_desescalada_verbal: {
        from: 'n_start_psiquiatrica',
        to: 'n_aislamiento_exitoso', // Cambio a nodo de continuidad
        effects: {
          empathy: 10,
          procedural: 5,
          security: 5,
          time: 5
        },
        desc: 'Iniciar di√°logo de desescalada verbal con tono calmado y respetuoso, manteniendo la distancia de seguridad.'
      },
      c_contencion_fisica_rapida: {
        from: 'n_start_psiquiatrica',
        to: 'n_end_fail_psiquiatrica',
        effects: {
          security: -10,
          empathy: -20,
          time: -5
        },
        desc: 'Intentar la contenci√≥n f√≠sica inmediata sin apoyo (alto riesgo de agravar la crisis y lesiones).'
      },
      c_aislamiento_zona: {
        from: 'n_start_psiquiatrica',
        to: 'n_aislamiento_exitoso', // Cambio a nodo de continuidad
        effects: {
          security: 10,
          comms: 5,
          procedural: 5
        },
        desc: 'Establecer un per√≠metro de seguridad, alejar a clientes y contener el √°rea (Acci√≥n de Seguridad).'
      },
      c_llamar_policia_medica: {
        from: 'n_start_psiquiatrica',
        to: 'n_aislamiento_exitoso', // Cambio a nodo de continuidad
        effects: {
          comms: 15,
          procedural: 10
        },
        desc: 'Llamar a servicios de emergencia (SAMU/Polic√≠a) e indicar que se trata de una crisis de salud mental.'
      },
      // OPCIONES PARA NODO 2 (n_aislamiento_exitoso) - Desescalada activa
      c_mantener_distancia_dialogo: {
        from: 'n_aislamiento_exitoso',
        to: 'n_desescalada_avanzada',
        effects: {
          security: 5,
          empathy: 10,
          procedural: 5
        },
        desc: 'Mantener la distancia de seguridad (2 brazos de largo) y continuar el di√°logo de desescalada, confirmando que la ayuda est√° cerca.'
      },
      c_ofrecer_agua_lugar_seguro: {
        from: 'n_aislamiento_exitoso',
        to: 'n_desescalada_avanzada',
        effects: {
          empathy: 15,
          time: 5
        },
        desc: 'Ofrecer una necesidad b√°sica (agua) y sugerir moverse a un √°rea de mayor calma y privacidad.'
      },
      c_acercarse_ayudar_fisico: { // Mal camino
        from: 'n_aislamiento_exitoso',
        to: 'n_end_fail_psiquiatrica',
        effects: {
          security: -15,
          empathy: -10
        },
        desc: 'Acercarse en solitario para intentar calmarlo con contacto f√≠sico o invadir su espacio personal.'
      },
      c_amenaza_uso_fuerza: { // Mal camino
        from: 'n_aislamiento_exitoso',
        to: 'n_end_fail_psiquiatrica',
        effects: {
          empathy: -20,
          procedural: -10
        },
        desc: 'Utilizar un tono de voz fuerte o amenazar con el uso de la fuerza/bast√≥n si no se calma.'
      },
      // OPCIONES PARA NODO 3 (n_desescalada_avanzada) - Cierre de caso
      c_coordinar_emergencia: {
        from: 'n_desescalada_avanzada',
        to: 'n_end_ok_psiquiatrica',
        effects: {
          procedural: 10,
          comms: 10,
          security: 5
        },
        desc: 'Establecer comunicaci√≥n con SAMU/Polic√≠a para entregar la situaci√≥n de forma coordinada, detallando el estado de la persona y el entorno.'
      },
      c_solicitar_identificacion: { // Mal camino
        from: 'n_desescalada_avanzada',
        to: 'n_end_fail_psiquiatrica',
        effects: {
          empathy: -10,
          procedural: -5
        },
        desc: 'Exigir inmediatamente la identificaci√≥n de la persona antes de que intervengan los servicios de emergencia.'
      },
      c_relajar_perimetro: { // Mal camino
        from: 'n_desescalada_avanzada',
        to: 'n_end_fail_psiquiatrica',
        effects: {
          security: -10
        },
        desc: 'Relajar completamente el per√≠metro de seguridad y dejar que la persona deambule libremente mientras espera a la polic√≠a.'
      },
      // OPCIONES PARA CORPORATIVO/OFICINAS
      c_desescalada_empatica: {
        from: 'n_start_acceso',
        to: 'n_dialogo',
        effects: {
          empathy: 10,
          procedural: 5
        },
        desc: 'Intentar desescalada verbal, reconociendo su frustraci√≥n y buscando un espacio seguro para hablar.'
      },
      c_solicitar_policia: {
        from: 'n_start_acceso',
        to: 'n_dialogo',
        effects: {
          comms: 15,
          security: 5
        },
        desc: 'Solicitar apoyo policial de inmediato e informar a la gerencia.'
      },
      c_bloqueo_fisico: {
        from: 'n_start_acceso',
        to: 'n_end_fail_acceso',
        effects: {
          security: -10
        },
        desc: 'Bloquear f√≠sicamente la puerta de acceso sin intentar di√°logo, escalando la tensi√≥n.'
      },
      c_barrera_fisica: {
        from: 'n_dialogo',
        to: 'n_end_ok_acceso',
        effects: {
          security: 15
        },
        desc: 'Crear una barrera f√≠sica (ej. mostrador) para interponerse y ganar tiempo hasta la llegada de polic√≠a.'
      },
      c_replegarse: {
        from: 'n_dialogo',
        to: 'n_end_fail_acceso',
        effects: {
          security: -15
        },
        desc: 'Retirarse de la zona de acceso para evitar la confrontaci√≥n (permite la entrada al sujeto).'
      }
    };
    
    // --- L√≥gica del Juego (Continuaci√≥n) ---

    function selectArea(areaId) {
        gameState.currentArea = areaId;
        const scenarios = SCENARIOS[areaId];
        const list = document.getElementById('scenarios-list');
        list.innerHTML = '';

        // Activar la clase 'selected'
        document.querySelectorAll('.area-card').forEach(card => card.classList.remove('selected'));
        const selectedCard = document.querySelector(`.area-card[data-area="${areaId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        // Mostrar escenarios
        if (scenarios && scenarios.length > 0) {
            scenarios.forEach(scenario => {
                const badgeClass = `difficulty-${scenario.difficulty}`;
                const scenarioElement = document.createElement('div');
                scenarioElement.className = 'scenario-card card';
                scenarioElement.setAttribute('tabindex', '0');
                scenarioElement.innerHTML = `
                  <div>
                    <h4 style="margin-bottom: 5px;">${scenario.title} <span class="difficulty-badge ${badgeClass}">${scenario.difficulty.toUpperCase()}</span></h4>
                    <p style="font-size: 13px; color: var(--text-secondary);">Tiempo Estimado: ${scenario.est_time} min</p>
                  </div>
                  <button class="primary" data-scenario-id="${scenario.id}">Iniciar</button>
                `;
                scenarioElement.querySelector('button').addEventListener('click', () => startScenario(scenario.id));
                list.appendChild(scenarioElement);
            });
            document.getElementById('scenarios-container').style.display = 'block';
        } else {
            list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No hay escenarios disponibles para esta √°rea.</p>';
            document.getElementById('scenarios-container').style.display = 'block';
        }
    }

    function startScenario(scenarioId) {
        const area = gameState.currentArea;
        if (!area || !SCENARIOS[area]) {
            showModal('Error', 'Debe seleccionar un √°rea de desempe√±o primero.');
            return;
        }
        const scenario = SCENARIOS[area].find(s => s.id === scenarioId);
        if (!scenario) {
            showModal('Error', 'Escenario no encontrado.');
            return;
        }

        // 1. Resetear Estado
        gameState.currentScenario = scenario;
        gameState.dimensions = {procedural: 0, security: 0, comms: 0, time: 0, empathy: 0};
        // Inicializar dimensiones con un valor base (ej. 20)
        DIMENSIONS.forEach(dim => gameState.dimensions[dim] = 20); 

        gameState.actions = [];
        gameState.tensionLevel = 0; // Resetear Tensi√≥n Operacional

        // 2. Actualizar UI y comenzar
        document.getElementById('scenario-title').textContent = scenario.title;
        document.getElementById('scenario-meta').innerHTML = `√Årea: ${scenario.area.toUpperCase()} | Dificultad: <span class="difficulty-badge difficulty-${scenario.difficulty}">${scenario.difficulty.toUpperCase()}</span> | Tiempo Estimado: ${scenario.est_time} min`;
        updateDimensionsDisplay();
        updateTensionDisplay();
        switchView('view-play');
        startTimer();

        // 3. Cargar el primer nodo
        loadNode(scenario.start);
    }

    function startRandomScenario() {
        const areas = Object.keys(SCENARIOS).filter(key => SCENARIOS[key].length > 0);
        if (areas.length === 0) {
            showModal('Error', 'No hay escenarios configurados.');
            return;
        }
        // Seleccionar un √°rea aleatoria
        const randomAreaId = areas[Math.floor(Math.random() * areas.length)];
        gameState.currentArea = randomAreaId;
        const scenarios = SCENARIOS[randomAreaId];
        
        // Seleccionar un escenario aleatorio
        const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
        startScenario(randomScenario.id);
    }

    function loadNode(nodeId) {
        const scenario = gameState.currentScenario;
        // Asumiendo que el escenario est√° definido globalmente o se puede inferir.
        // Aqu√≠ usamos la estructura global NODES
        const node = NODES[nodeId]; 
        
        if (!node) {
            showModal('Error de Configuraci√≥n', `El nodo "${nodeId}" no existe.`);
            return;
        }

        gameState.currentNode = nodeId;
        gameState.nodeLoadTime = Date.now(); // Registrar el tiempo de carga del nodo

        // 1. Mostrar el contenido del nodo
        document.getElementById('node-text').textContent = node.text;

        // 2. Ocultar feedback (Se muestra/Oculta al manejar la elecci√≥n)
        // document.getElementById('feedback-card').style.display = 'none';

        // 3. Mostrar opciones o finalizar
        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';

        if (node.type === 'end') {
            stopTimer();
            const finalScore = calculatePartialScore();
            // Generar mensaje final basado en la puntuaci√≥n
            let endMessage = node.text; // Usar el texto de finalizaci√≥n del nodo

            // Un peque√±o retraso para que el usuario lea el resultado del √∫ltimo nodo
            setTimeout(() => showReport(finalScore, endMessage), 2000);
        } else {
            // Mostrar las opciones
            const nodeChoices = node.choices;
            if (nodeChoices && nodeChoices.length > 0) {
                nodeChoices.forEach(choiceId => {
                    const choice = CHOICES[choiceId];
                    if (choice && choice.from === nodeId) { // Verificar que la opci√≥n es v√°lida para este nodo
                        const choiceElement = document.createElement('div');
                        choiceElement.className = 'choice-btn';
                        choiceElement.setAttribute('tabindex', '0');
                        choiceElement.innerHTML = `
                          <div class="choice-title">Acci√≥n: ${choice.desc}</div>
                          <div class="choice-effects" style="opacity: 0.5;">
                            ${DIMENSIONS.map(dim => {
                                const effect = choice.effects[dim] || 0;
                                if (effect !== 0) {
                                    const sign = effect > 0 ? '+' : '';
                                    const colorClass = effect > 0 ? 'effect-positive' : 'effect-negative';
                                    return `<span class="effect-tag ${colorClass}">${sign}${effect} ${dim.charAt(0).toUpperCase() + dim.slice(1)}</span>`;
                                }
                                return '';
                            }).join('')}
                            <span class="effect-tag">Tiempo: Variable</span>
                          </div>
                        `;
                        choiceElement.addEventListener('click', () => handleChoice(choiceId));
                        choicesDiv.appendChild(choiceElement);
                    }
                });
            } else {
                choicesDiv.innerHTML = '<p style="color: var(--danger);">Error: No hay opciones disponibles para este nodo.</p>';
            }
        }
    }

    function handleChoice(choiceId) {
        const choice = CHOICES[choiceId];
        if (!choice) return;

        const reactionTime = Date.now() - gameState.nodeLoadTime;
        const isFirstChoice = (gameState.actions.length === 0);
        
        let timePenalty = 0;
        let reactionFeedback = '';

        // 1. C√°lculo de Penalizaci√≥n/Bono por Tiempo
        if (reactionTime > MAX_REACTION_TIME) {
            timePenalty = -10;
            reactionFeedback = '<strong>üî¥ Vacilaci√≥n Cr√≠tica:</strong> Tom√≥ demasiado tiempo para reaccionar. La situaci√≥n se deteriora.';
        } else if (reactionTime < MIN_REACTION_TIME) {
            timePenalty = -5;
            reactionFeedback = '<strong>‚ö†Ô∏è Impulsividad:</strong> Reacci√≥n demasiado r√°pida. El riesgo de errores de procedimiento aumenta.';
        } else {
            timePenalty = 5;
            reactionFeedback = '<strong>‚úÖ Reacci√≥n √ìptima:</strong> La respuesta fue oportuna y bien medida.';
        }
        
        // 2. Aplicar el efecto de la elecci√≥n y calcular el efecto neto
        let netEffect = timePenalty; // Iniciar con el efecto del tiempo
        let securityWasPenalized = false;
        
        DIMENSIONS.forEach(dim => {
            const effect = choice.effects[dim] || 0;
            netEffect += effect;

            if (dim === 'security' && effect < 0) {
                securityWasPenalized = true;
            }

            // Aplicar el efecto y asegurar que la puntuaci√≥n no baje de 0 ni suba de 20
            gameState.dimensions[dim] = Math.min(20, Math.max(0, gameState.dimensions[dim] + effect));
        });

        // Aplicar el efecto del tiempo por separado para que el valor ya est√© reflejado en la dimensi√≥n
        gameState.dimensions['time'] = Math.min(20, Math.max(0, gameState.dimensions['time'] + timePenalty));

        // 3. Ajustar la tensi√≥n (sin impacto en el criterio de feedback por ser un valor derivado)
        let tensionChange = -(choice.effects.security || 0) + (choice.effects.empathy || 0); 
        gameState.tensionLevel = Math.max(0, gameState.tensionLevel + tensionChange);


        // 4. Determinar si se debe mostrar feedback inmediato (L√≥gica nueva del usuario)
        let shouldDisplayFeedback = false;
        
        if (securityWasPenalized) {
            shouldDisplayFeedback = true; // Error cr√≠tico: penalizaci√≥n directa en seguridad
        } else if (netEffect < 0) {
            shouldDisplayFeedback = true; // Error general: efecto neto negativo
        } else if (timePenalty < 0) {
            shouldDisplayFeedback = true; // Error de tiempo: penalizaci√≥n por vacilaci√≥n o impulsividad
        }


        // 5. Determinar el siguiente nodo y aplicar L√ìGICA DE VALIDACI√ìN DE UMBRAL T√ÅCTICO
        let nextNodeId = choice.to;
        const targetNode = NODES[nextNodeId]; 

        // --- 5.1. Chequeo de Falla Cr√≠tica Inmediata (Solo en la primera acci√≥n) ---
        if (isFirstChoice && gameState.dimensions.security < CRITICAL_SECURITY_THRESHOLD) {
            nextNodeId = GENERIC_CRITICAL_FAIL_NODE;
            shouldDisplayFeedback = true; // Forzar feedback en caso de fallo cr√≠tico
        } 
        
        // --- 5.2. Chequeo de Falla por Porcentaje al Final ---
        if (targetNode && targetNode.type === 'end' && nextNodeId !== GENERIC_CRITICAL_FAIL_NODE) {
            const finalScoreEstimate = calculatePartialScore();
            if (finalScoreEstimate < MINIMUM_PASSING_SCORE) {
                // Redirigir al nodo de falla por score bajo.
                nextNodeId = MISSION_TOTAL_FAIL_NODE;
                shouldDisplayFeedback = true; // Forzar feedback al final de la misi√≥n fallida
            }
        }
        
        // 6. Registrar la acci√≥n
        gameState.actions.push({
            nodeId: gameState.currentNode,
            choiceDesc: choice.desc,
            effects: choice.effects,
            time_penalty: timePenalty, // Registrar el efecto del tiempo para el reporte
            time: reactionTime / 1000, // segundos
            feedback: reactionFeedback
        });

        // 7. Mostrar Feedback Inmediato (si aplica)
        // Se pasa la decisi√≥n de si mostrar o no la tarjeta.
        showFeedback(choice, reactionFeedback, shouldDisplayFeedback);

        // 8. Actualizar UI
        updateDimensionsDisplay();
        updateTensionDisplay();

        // 9. Cargar el siguiente nodo
        loadNode(nextNodeId);
    }

    // MODIFICADA: Ahora recibe un flag para decidir si debe mostrar la tarjeta.
    function showFeedback(choice, reactionFeedback, shouldDisplay) {
        const feedbackCard = document.getElementById('feedback-card');
        const feedbackContent = document.getElementById('immediate-feedback');
        
        // NUEVA L√ìGICA: Ocultar si no se debe mostrar feedback por ser una respuesta correcta/neutral
        if (!shouldDisplay) {
            feedbackCard.style.display = 'none';
            return;
        }

        // Si llega aqu√≠, es porque shouldDisplay es true (acci√≥n sub√≥ptima/err√≥nea/penalizada)
        
        // Determinar si el feedback es positivo o negativo para el color de la tarjeta
        // Usamos el √∫ltimo elemento registrado en actions para obtener el time_penalty
        const lastAction = gameState.actions[gameState.actions.length - 1];
        const totalEffect = DIMENSIONS.reduce((sum, dim) => sum + (choice.effects[dim] || 0), 0) + (lastAction?.time_penalty || 0); 
        
        if (totalEffect < 0 || gameState.dimensions.security < CRITICAL_SECURITY_THRESHOLD) {
            feedbackCard.classList.add('warning');
            feedbackCard.style.borderLeftColor = 'var(--danger)';
        } else {
            feedbackCard.classList.remove('warning');
            feedbackCard.style.borderLeftColor = 'var(--success)';
        }

        feedbackContent.innerHTML = `
          <p style="font-size: 15px; margin-bottom: 10px;"><strong>Acci√≥n:</strong> ${choice.desc}</p>
          <p style="font-size: 14px; margin-bottom: 10px;">${reactionFeedback}</p>
          <div class="choice-effects">
            ${DIMENSIONS.map(dim => {
                const effect = choice.effects[dim] || 0;
                // Incluir el time_penalty solo en la dimensi√≥n 'time'
                const finalEffect = (dim === 'time') ? effect + (lastAction?.time_penalty || 0) : effect; 
                
                if (finalEffect !== 0) {
                    const sign = finalEffect > 0 ? 'üî∫' : 'üîª';
                    const color = finalEffect > 0 ? 'var(--success)' : 'var(--danger)';
                    return `<span style="color: ${color}; font-weight: 600;">${sign} ${Math.abs(finalEffect)} ${dim.charAt(0).toUpperCase() + dim.slice(1)}</span>`;
                }
                return '';
            }).filter(h => h.trim() !== '').join('<span style="color: var(--text-secondary);"> | </span>')}
          </div>
        `;
        feedbackCard.style.display = 'block';
    }

    function showReport(finalScore, endMessage) {
        switchView('view-report');
        
        document.getElementById('final-score').textContent = `${finalScore}%`;
        
        let subtitle = 'Desempe√±o Aceptable. Hubo puntos cr√≠ticos, pero la misi√≥n fue completada.';
        if (finalScore >= 80) {
            subtitle = '¬°√âxito T√°ctico! Demostraste un nivel de protocolo y control excepcional.';
        } else if (finalScore < MINIMUM_PASSING_SCORE) {
            subtitle = 'Falla Cr√≠tica. El procedimiento fall√≥ y el riesgo operacional aument√≥. Se requiere reentrenamiento.';
        } else if (finalScore >= MINIMUM_PASSING_SCORE) {
             subtitle = 'Desempe√±o Satisfactorio. Cumpliste con el umbral m√≠nimo de aprobaci√≥n, pero hay espacio para mejorar.';
        }
        document.querySelector('.report-header .subtitle').textContent = subtitle;

        // Secci√≥n de Retroalimentaci√≥n
        document.getElementById('report-feedback').innerHTML = `
            <p style="color: var(--text-primary); font-size: 16px;"><strong>Conclusi√≥n del Escenario:</strong> ${endMessage}</p>
            <p style="margin-top: 15px; color: var(--text-secondary);">El an√°lisis detallado de sus acciones se encuentra a continuaci√≥n. Preste especial atenci√≥n a las dimensiones con puntuaciones m√°s bajas.</p>
        `;


        // Secci√≥n de Dimensiones
        const reportDimensions = document.getElementById('report-dimensions');
        reportDimensions.innerHTML = DIMENSIONS.map(dim => {
            const value = gameState.dimensions[dim];
            const maxVal = 20; // Max points
            const percentage = Math.round((value / maxVal) * 100);
            
            let color = 'var(--success)';
            if (percentage < 50) color = 'var(--danger)';
            else if (percentage < 75) color = 'var(--warning)';

            return `
              <div class="dimension-item">
                <span class="dimension-label">${dim.charAt(0).toUpperCase() + dim.slice(1)} (${percentage}%)</span>
                <span class="dimension-value" style="color: ${color};">${value}/${maxVal}</span>
              </div>
            `;
        }).join('');

        // Secci√≥n de Acciones
        const reportActions = document.getElementById('report-actions');
        reportActions.innerHTML = gameState.actions.map((action, index) => {
            const effectsHTML = DIMENSIONS.map(dim => {
                let effect = action.effects[dim] || 0;
                // Incluir la penalizaci√≥n/bono de tiempo en la dimensi√≥n 'time'
                if (dim === 'time') {
                    effect += action.time_penalty || 0;
                }
                
                if (effect !== 0) {
                    const sign = effect > 0 ? '+' : '';
                    const color = effect > 0 ? 'var(--success)' : 'var(--danger)';
                    return `<span style="color: ${color};">${sign}${effect} ${dim}</span>`;
                }
                return '';
            }).filter(h => h.length > 0).join(' | ');

            return `
              <div class="action-item">
                <p style="font-weight: 600;">Paso ${index + 1}: ${action.choiceDesc}</p>
                <p style="font-size: 13px; color: var(--text-secondary);">Tiempo de Reacci√≥n: ${action.time.toFixed(2)}s. ${action.feedback}</p>
                <p style="font-size: 13px; margin-top: 5px;">Efectos: ${effectsHTML}</p>
              </div>
            `;
        }).join('');

        // Manejadores de Botones
        document.getElementById('btn-replay').onclick = () => {
            // CAMBIO SOLICITADO: Reinicia directamente el mismo escenario.
            if (gameState.currentScenario) {
                 startScenario(gameState.currentScenario.id); 
            } else {
                 selectArea(gameState.currentArea); // Fallback
            }
        };
        document.getElementById('btn-export-json').onclick = exportReport;
        document.getElementById('btn-print').onclick = printReport;
    }

    function resetGame() {
        if (gameState.timerInterval) stopTimer();
        gameState = {
          currentArea: null,
          currentScenario: null,
          currentNode: null,
          dimensions: {procedural: 0, security: 0, comms: 0, time: 0, empathy: 0},
          actions: [],
          startTime: null,
          timerInterval: null,
          score: 0,
          tensionLevel: 0,
          nodeLoadTime: 0,
          faceAnalysisActive: gameState.faceAnalysisActive // Mantiene el estado de la biometr√≠a
        };
        
        // Asegurar que las dimensiones se reinicien al valor inicial de 20
        DIMENSIONS.forEach(dim => gameState.dimensions[dim] = 20); 

        updateDimensionsDisplay();
        updateTensionDisplay();
        switchView('view-area');
        document.querySelectorAll('.area-card').forEach(card => card.classList.remove('selected'));
        document.getElementById('scenarios-container').style.display = 'none';
        
        if (gameState.faceAnalysisActive) {
            // No desactiva la c√°mara si est√° activa, solo la bandera visual, para no pedir permisos de nuevo
        }
        
        showModal('‚ôªÔ∏è Sistema Reiniciado', 'El simulador ha sido reseteado. Por favor, seleccione un √°rea de desempe√±o para comenzar.');
    }


    // --- Utilidades de Guardado/Carga y Exportaci√≥n ---
    function saveSession() {
        const sessionName = document.getElementById('user-name').value || 'Sesi√≥n An√≥nima';
        const sessionData = {
            state: gameState,
            userData: {
                name: document.getElementById('user-name').value,
                rut: document.getElementById('user-rut').value,
                facility: document.getElementById('user-facility').value,
            },
            timestamp: new Date().toLocaleString()
        };
        try {
            localStorage.setItem(`session_${sessionName}`, JSON.stringify(sessionData));
            updateSessionCount();
            showModal('üíæ Sesi√≥n Guardada', `La sesi√≥n fue guardada con √©xito como: <strong>${sessionName}</strong>.`);
        } catch (e) {
            showModal('‚ùå Error de Guardado', 'No se pudo guardar la sesi√≥n en el navegador.');
        }
    }

    function loadSession() {
        const sessionName = document.getElementById('user-name').value;
        if (!sessionName) {
            showModal('‚ö†Ô∏è Nombre Requerido', 'Por favor, ingrese el nombre exacto de la sesi√≥n a cargar.');
            return;
        }

        const sessionDataString = localStorage.getItem(`session_${sessionName}`);
        if (sessionDataString) {
            try {
                const sessionData = JSON.parse(sessionDataString);
                gameState = sessionData.state;
                
                // Cargar datos de usuario
                document.getElementById('user-name').value = sessionData.userData.name;
                document.getElementById('user-rut').value = sessionData.userData.rut;
                document.getElementById('user-facility').value = sessionData.userData.facility;

                // Reanudar el juego si est√° en medio de un escenario
                if (gameState.currentScenario && gameState.currentNode) {
                    // Simular inicio para cargar la UI
                    selectArea(gameState.currentArea); 
                    startScenario(gameState.currentScenario.id); 
                    loadNode(gameState.currentNode); // Cargar el nodo espec√≠fico
                    startTimer(); // Reiniciar el temporizador
                    switchView('view-play');
                } else {
                    selectArea(gameState.currentArea);
                    switchView('view-area');
                }
                
                updateDimensionsDisplay();
                updateTensionDisplay();

                showModal('üìÇ Sesi√≥n Cargada', `Sesi√≥n <strong>${sessionName}</strong> cargada con √©xito. Reanudada desde el nodo <strong>${gameState.currentNode}</strong>.`);

            } catch (e) {
                showModal('‚ùå Error de Carga', 'El archivo de sesi√≥n est√° corrupto o no es v√°lido.');
            }
        } else {
            showModal('‚ùå Sesi√≥n No Encontrada', `No se encontr√≥ ninguna sesi√≥n guardada con el nombre: <strong>${sessionName}</strong>.`);
        }
    }

    function updateSessionCount() {
        let count = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('session_')) {
                count++;
            }
        }
        document.getElementById('sessions-count').textContent = count;
    }

    function exportReport() {
        const reportData = {
            report_title: `Reporte T√°ctico: ${gameState.currentScenario.title}`,
            user_data: {
                name: document.getElementById('user-name').value,
                rut: document.getElementById('user-rut').value,
                facility: document.getElementById('user-facility').value,
            },
            scenario: {
                area: gameState.currentArea,
                title: gameState.currentScenario.title,
                difficulty: gameState.currentScenario.difficulty,
                total_time: document.getElementById('timer-value').textContent,
            },
            results: {
                final_score: document.getElementById('final-score').textContent,
                dimensions: gameState.dimensions,
                actions_taken: gameState.actions,
                final_message: document.getElementById('report-feedback').querySelector('strong').textContent
            }
        };

        const jsonString = JSON.stringify(reportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Reporte_Tactico_${gameState.currentScenario.id}_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function printReport() {
        // Simple print function for the report view
        const printContent = document.getElementById('view-report').innerHTML;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Reporte T√°ctico</title>');
        printWindow.document.write('<style>');
        // Incluir solo los estilos necesarios para el reporte y la legibilidad
        printWindow.document.write(`
            body { font-family: 'Inter', sans-serif; color: #333; margin: 20px; }
            .report-container { max-width: 750px; margin: 0 auto; }
            .card { border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
            h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-bottom: 15px; }
            .final-score { font-size: 48px; font-weight: bold; color: #10b981; }
            .report-section h3 { color: #007bff; font-size: 18px; margin-bottom: 10px; }
            .dimension-item, .action-item { padding: 10px; border-left: 3px solid #ccc; margin-bottom: 8px; background: #f9f9f9; border-radius: 4px; }
            .dimension-value { font-weight: bold; }
        `);
        printWindow.document.write('</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    }
    
    // --- L√≥gica de Administraci√≥n de JSON (Escenarios) ---
    function toggleAdminPanel() {
        const panel = document.getElementById('admin-panel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }
    
    // NOTA: Para una implementaci√≥n real, se necesitar√≠a l√≥gica de `loadJsonAdmin` para sobrescribir
    // SCENARIOS y NODES de forma segura, pero por ahora solo se implementan los handlers.
    
    // --- Inicializaci√≥n ---

    function init() {
        // Inicializar part√≠culas de fondo (simulaci√≥n de HUD futurista)
        const particlesContainer = document.getElementById('particles');
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animationDelay = `${Math.random() * 20}s`;
            particlesContainer.appendChild(particle);
        }


        // Event listeners principales
        document.querySelectorAll('.area-card').forEach(card => {
            card.addEventListener('click', () => selectArea(card.dataset.area));
        });
        
        document.getElementById('btn-random').addEventListener('click', startRandomScenario);
        document.getElementById('btn-reset').addEventListener('click', resetGame);
        document.getElementById('btn-face-analysis').addEventListener('click', toggleFaceAnalysis);
        document.getElementById('btn-save-session').addEventListener('click', saveSession);
        document.getElementById('btn-load-session').addEventListener('click', loadSession);
        document.getElementById('btn-admin').addEventListener('click', toggleAdminPanel);
        
        // Simular carga de escenarios al inicio
        updateSessionCount();
        
        // Selecci√≥n inicial por defecto si el usuario no hace clic
        selectArea('comercial'); // Seleccionar comercial por defecto.
    }

    // Asegurar que el juego est√° listo
    window.onload = init;

  </script>
</body>

</html>